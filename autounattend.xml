<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State">
  <!-- XML Generated by Winhance https://github.com/memstechtips/Winhance -->
  <settings pass="offlineServicing"></settings>
  <settings pass="windowsPE">
    <component name="Microsoft-Windows-Setup" processorArchitecture="x86" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <UserData>
        <ProductKey>
          <Key>00000-00000-00000-00000-00000</Key>
          <WillShowUI>Always</WillShowUI>
        </ProductKey>
        <AcceptEula>true</AcceptEula>
      </UserData>
      <RunSynchronous>
        <RunSynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Order 1-6: Skip Windows 11 Hardware Requirement Checks</Description>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassTPMCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassSecureBootCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassStorageCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassCPUCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassRAMCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>6</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassDiskCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
      </RunSynchronous>
    </component>
    <component name="Microsoft-Windows-Setup" processorArchitecture="arm64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <UserData>
        <ProductKey>
          <Key>00000-00000-00000-00000-00000</Key>
          <WillShowUI>Always</WillShowUI>
        </ProductKey>
        <AcceptEula>true</AcceptEula>
      </UserData>
      <RunSynchronous>
        <RunSynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Order 1-6: Skip Windows 11 Hardware Requirement Checks</Description>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassTPMCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassSecureBootCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassStorageCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassCPUCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassRAMCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>6</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassDiskCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
      </RunSynchronous>
    </component>
    <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <UserData>
        <ProductKey>
          <Key>00000-00000-00000-00000-00000</Key>
          <WillShowUI>Always</WillShowUI>
        </ProductKey>
        <AcceptEula>true</AcceptEula>
      </UserData>
      <RunSynchronous>
        <RunSynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Order 1-6: Skip Windows 11 Hardware Requirement Checks</Description>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassTPMCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassSecureBootCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassStorageCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassCPUCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassRAMCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>6</Order>
          <Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassDiskCheck /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
      </RunSynchronous>
    </component>
  </settings>
  <settings pass="generalize"></settings>
  <settings pass="specialize">
    <component name="Microsoft-Windows-Deployment" processorArchitecture="x86" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <RunSynchronous>
        <RunSynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Loads Scripts in this XML File</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -Command "$xml = [xml]::new(); $xml.Load('C:\Windows\Panther\unattend.xml'); $sb = [scriptblock]::Create( $xml.unattend.Extensions.ExtractScript ); Invoke-Command -ScriptBlock $sb -ArgumentList $xml;"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Description>Registry Entry to Create a Local Account during OOBE</Description>
          <Path>reg.exe add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OOBE" /v BypassNRO /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Description>Disable All Network Adapters Temporarily so Windows Doesn't Update During OOBE and to Allow Local Account Creation</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Get-NetAdapter | Disable-NetAdapter -Confirm:$false"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Description>Enables .NET Framework 3.5 from Windows Installation Media</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -Command "foreach($d in 'C','D','E','F','G','H','I','J','K'){$src=Join-Path ($d+':') 'sources\sxs';if(Test-Path $src\*.cab){dism /Online /Enable-Feature /FeatureName:NetFx3 /All /LimitAccess /Source:$src;break}}"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Description>Runs Winhance Script System Wide Operations like App Uninstalls, HKLM Registry entries etc.</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -File "C:\ProgramData\Winhance\Unattend\Scripts\Winhancements.ps1"</Path>
        </RunSynchronousCommand>
      </RunSynchronous>
    </component>
    <component name="Microsoft-Windows-Deployment" processorArchitecture="arm64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <RunSynchronous>
        <RunSynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Loads Scripts in this XML File</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -Command "$xml = [xml]::new(); $xml.Load('C:\Windows\Panther\unattend.xml'); $sb = [scriptblock]::Create( $xml.unattend.Extensions.ExtractScript ); Invoke-Command -ScriptBlock $sb -ArgumentList $xml;"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Description>Registry Entry to Create a Local Account during OOBE</Description>
          <Path>reg.exe add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OOBE" /v BypassNRO /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Description>Disable All Network Adapters Temporarily so Windows Doesn't Update During OOBE and to Allow Local Account Creation</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Get-NetAdapter | Disable-NetAdapter -Confirm:$false"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Description>Enables .NET Framework 3.5 from Windows Installation Media</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -Command "foreach($d in 'C','D','E','F','G','H','I','J','K'){$src=Join-Path ($d+':') 'sources\sxs';if(Test-Path $src\*.cab){dism /Online /Enable-Feature /FeatureName:NetFx3 /All /LimitAccess /Source:$src;break}}"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Description>Runs Winhance Script System Wide Operations like App Uninstalls, HKLM Registry entries etc.</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -File "C:\ProgramData\Winhance\Unattend\Scripts\Winhancements.ps1"</Path>
        </RunSynchronousCommand>
      </RunSynchronous>
    </component>
    <component name="Microsoft-Windows-Deployment" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <RunSynchronous>
        <RunSynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Loads Scripts in this XML File</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -Command "$xml = [xml]::new(); $xml.Load('C:\Windows\Panther\unattend.xml'); $sb = [scriptblock]::Create( $xml.unattend.Extensions.ExtractScript ); Invoke-Command -ScriptBlock $sb -ArgumentList $xml;"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Description>Registry Entry to Create a Local Account during OOBE</Description>
          <Path>reg.exe add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OOBE" /v BypassNRO /t REG_DWORD /d 1 /f</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Description>Disable All Network Adapters Temporarily so Windows Doesn't Update During OOBE and to Allow Local Account Creation</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Get-NetAdapter | Disable-NetAdapter -Confirm:$false"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Description>Enables .NET Framework 3.5 from Windows Installation Media</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -Command "foreach($d in 'C','D','E','F','G','H','I','J','K'){$src=Join-Path ($d+':') 'sources\sxs';if(Test-Path $src\*.cab){dism /Online /Enable-Feature /FeatureName:NetFx3 /All /LimitAccess /Source:$src;break}}"</Path>
        </RunSynchronousCommand>
        <RunSynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Description>Runs Winhance Script System Wide Operations like App Uninstalls, HKLM Registry entries etc.</Description>
          <Path>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -File "C:\ProgramData\Winhance\Unattend\Scripts\Winhancements.ps1"</Path>
        </RunSynchronousCommand>
      </RunSynchronous>
    </component>
  </settings>
  <settings pass="auditSystem"></settings>
  <settings pass="auditUser"></settings>
  <settings pass="oobeSystem">
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="x86" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
      </OOBE>
      <FirstLogonCommands>
        <SynchronousCommand>
        <Order>1</Order>
        <Description>Enables Network Adapters After OOBE Completes</Description>
        <CommandLine>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Get-NetAdapter | Enable-NetAdapter -Confirm:$false"</CommandLine>
        </SynchronousCommand>
    </FirstLogonCommands>
    </component>
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="arm64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
      </OOBE>
      <FirstLogonCommands>
        <SynchronousCommand>
        <Order>1</Order>
        <Description>Enables Network Adapters After OOBE Completes</Description>
        <CommandLine>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Get-NetAdapter | Enable-NetAdapter -Confirm:$false"</CommandLine>
        </SynchronousCommand>
    </FirstLogonCommands>
    </component>
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
      </OOBE>
      <FirstLogonCommands>
        <SynchronousCommand>
        <Order>1</Order>
        <Description>Enables Network Adapters After OOBE Completes</Description>
        <CommandLine>powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -Command "Get-NetAdapter | Enable-NetAdapter -Confirm:$false"</CommandLine>
        </SynchronousCommand>
    </FirstLogonCommands>
    </component>
  </settings>
  <Extensions xmlns="urn:winhance:unattend">
    <ExtractScript>
param(
    [xml] $Document
);

$scriptsDir = 'C:\ProgramData\Winhance\Unattend\Scripts\';
foreach( $file in $Document.unattend.Extensions.File ) {
    $path = [System.Environment]::ExpandEnvironmentVariables(
        $file.GetAttribute( 'path' )
    );
    if( $path.StartsWith( $scriptsDir ) ) {
        mkdir -Path $scriptsDir -ErrorAction 'SilentlyContinue';
    }
    $encoding = switch( [System.IO.Path]::GetExtension( $path ) ) {
        { $_ -in '.ps1', '.xml' } { [System.Text.Encoding]::UTF8; }
        { $_ -in '.reg', '.vbs', '.js' } { [System.Text.UnicodeEncoding]::new( $false, $true ); }
        default { [System.Text.Encoding]::Default; }
    };
    [System.IO.File]::WriteAllBytes( $path, ( $encoding.GetPreamble() + $encoding.GetBytes( $file.InnerText.Trim() ) ) );
}
		</ExtractScript>
    <File path="C:\ProgramData\Winhance\Unattend\Scripts\Winhancements.ps1"><![CDATA[<#
.SYNOPSIS
    Winhance Windows 10/11 Customization and Optimization Script
.DESCRIPTION
    Applies registry settings, UWP app removals, optimizations and customizations based on Windows version detection
.NOTES
    Requires Administrator privileges
    Compatible with Windows 10 and Windows 11
    Logs all activities to C:\ProgramData\Winhance\Unattend\Logs\Winhancements.txt
.PARAMETER UserCustomizations
    When specified, applies ONLY HKCU (user-specific) registry settings.
    When not specified, applies all settings EXCEPT HKCU entries.
    Note: User customizations are tracked and will only apply once per user.
    To re-apply, delete: HKCU\Software\Winhance\UserCustomizationsApplied
.EXAMPLE
    .\Winhancements.ps1
    Runs in normal mode - applies all system-wide settings (HKLM) but skips user settings (HKCU)
.EXAMPLE
    .\Winhancements.ps1 -UserCustomizations
    Runs in user mode - applies ONLY user-specific settings (HKCU)
#>

param(
    [switch]$UserCustomizations
)

# ============================================================================
# LOGGING SETUP
# ============================================================================

$LogPath = 'C:\ProgramData\Winhance\Unattend\Logs\Winhancements.txt'
$null = New-Item -Path (Split-Path $LogPath) -ItemType Directory -Force

function Write-Log {
    param(
        [string]$Message,
        [ValidateSet("INFO", "SUCCESS", "WARNING", "ERROR")]
        [string]$Level = "INFO"
    )
    
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $LogEntry = "[$Timestamp] [$Level] $Message"
    
    # Write to log file
    Add-Content -Path $LogPath -Value $LogEntry -Encoding UTF8
    
    # Optional: Also write to console for real-time monitoring
    # Uncomment the next line if you want console output during testing
    # Write-Host $LogEntry
}

# Initialize log file
Write-Log "=================================================================================" "INFO"
Write-Log "Winhance Windows Optimization & Customization Script Started" "INFO"
Write-Log "Script Path: $($MyInvocation.MyCommand.Path)" "INFO"
Write-Log "Log File: $LogPath" "INFO"
if ($UserCustomizations) {
    Write-Log "MODE: User Customizations Only (HKCU registry entries)" "INFO"
} else {
    Write-Log "MODE: System Customizations (All settings except HKCU entries)" "INFO"
}
Write-Log "=================================================================================" "INFO"


function Get-TargetUser {
    try {
        $user = Get-WmiObject Win32_ComputerSystem | Select-Object -ExpandProperty UserName
        if ($user -and $user -ne "NT AUTHORITY\SYSTEM") {
            $username = $user.Split('\')[1]
            if ($username -ne "defaultuser0") {
                return $username
            }
        }
    } catch { }

    try {
        $explorer = Get-Process explorer -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($explorer) {
            $owner = $explorer.GetOwner()
            if ($owner.User -ne "defaultuser0") {
                return $owner.User
            }
        }
    } catch { }

    return $null
}

function Get-UserSID {
    param($Username)
    try {
        $user = New-Object System.Security.Principal.NTAccount($Username)
        return $user.Translate([System.Security.Principal.SecurityIdentifier]).Value
    } catch {
        return $null
    }
}

function Set-RegistryValue {
    param(
        [string]$Path,
        [string]$Name,
        [string]$Type,
        $Value,
        [string]$Description
    )

    try {
        if (-not (Test-Path $Path)) {
            New-Item -Path $Path -Force | Out-Null
        }
        Set-ItemProperty -Path $Path -Name $Name -Value $Value -Type $Type -Force
        Write-Log "$Description | $Path\$Name = $Value" "SUCCESS"
    }
    catch {
        Write-Log "Failed to set $Path\$Name : $($_.Exception.Message)" "ERROR"
    }
}

function Remove-RegistryValue {
    param(
        [string]$Path,
        [string]$Name,
        [string]$Description
    )

    try {
        if (Test-Path $Path) {
            $existingValue = Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue
            if ($existingValue) {
                Remove-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue
                Write-Log "$Description | Removed $Path\$Name" "SUCCESS"
            }
        }
    }
    catch {
        Write-Log "Failed to remove $Path\$Name : $($_.Exception.Message)" "ERROR"
    }
}

function Remove-RegistryKey {
    param(
        [string]$Path,
        [string]$Description
    )

    try {
        if (Test-Path $Path) {
            Remove-Item -Path $Path -Recurse -Force -ErrorAction SilentlyContinue
            Write-Log "$Description | Removed key $Path" "SUCCESS"
        }
    }
    catch {
        Write-Log "Failed to remove key $Path : $($_.Exception.Message)" "ERROR"
    }
}

function New-RegistryKey {
    param(
        [string]$Path,
        [string]$Description
    )

    try {
        if (-not (Test-Path $Path)) {
            New-Item -Path $Path -Force | Out-Null
            Write-Log "$Description | Created key $Path" "SUCCESS"
        }
    }
    catch {
        Write-Log "Failed to create key $Path : $($_.Exception.Message)" "ERROR"
    }
}

function Set-BinaryBit {
    param(
        [string]$Path,
        [string]$Name,
        [int]$ByteIndex,
        [byte]$BitMask,
        [bool]$SetBit,
        [string]$Description
    )

    try {
        if (-not (Test-Path $Path)) {
            New-Item -Path $Path -Force | Out-Null
        }

        $currentValue = Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue
        if ($null -eq $currentValue -or $null -eq $currentValue.$Name) {
            $bytes = New-Object byte[] ([Math]::Max(12, $ByteIndex + 1))
        } else {
            $bytes = $currentValue.$Name
            if ($bytes.Length -le $ByteIndex) {
                $newBytes = New-Object byte[] ($ByteIndex + 1)
                [Array]::Copy($bytes, $newBytes, $bytes.Length)
                $bytes = $newBytes
            }
        }

        if ($SetBit) {
            $bytes[$ByteIndex] = $bytes[$ByteIndex] -bor $BitMask
        } else {
            $bytes[$ByteIndex] = $bytes[$ByteIndex] -band (-bnot $BitMask)
        }

        Set-ItemProperty -Path $Path -Name $Name -Value $bytes -Type Binary -Force
        Write-Log "$Description | $Path\$Name bit mask 0x$($BitMask.ToString('X2')) at byte $ByteIndex = $SetBit" "SUCCESS"
    }
    catch {
        Write-Log "Failed to modify binary bit $Path\$Name : $($_.Exception.Message)" "ERROR"
    }
}

function Set-BinaryByte {
    param(
        [string]$Path,
        [string]$Name,
        [int]$ByteIndex,
        [byte]$ByteValue,
        [string]$Description
    )

    try {
        if (-not (Test-Path $Path)) {
            New-Item -Path $Path -Force | Out-Null
        }

        $currentValue = Get-ItemProperty -Path $Path -Name $Name -ErrorAction SilentlyContinue
        if ($null -eq $currentValue -or $null -eq $currentValue.$Name) {
            $bytes = New-Object byte[] ([Math]::Max(12, $ByteIndex + 1))
        } else {
            $bytes = $currentValue.$Name
            if ($bytes.Length -le $ByteIndex) {
                $newBytes = New-Object byte[] ($ByteIndex + 1)
                [Array]::Copy($bytes, $newBytes, $bytes.Length)
                $bytes = $newBytes
            }
        }

        $bytes[$ByteIndex] = $ByteValue
        Set-ItemProperty -Path $Path -Name $Name -Value $bytes -Type Binary -Force
        Write-Log "$Description | $Path\$Name byte $ByteIndex = 0x$($ByteValue.ToString('X2'))" "SUCCESS"
    }
    catch {
        Write-Log "Failed to modify binary byte $Path\$Name : $($_.Exception.Message)" "ERROR"
    }
}


if (-not $UserCustomizations) {

    $scriptsDir = "C:\ProgramData\Winhance\Scripts"
    if (!(Test-Path $scriptsDir)) {
        New-Item -ItemType Directory -Path $scriptsDir -Force | Out-Null
        Write-Log "Created scripts directory: $scriptsDir" "SUCCESS"
    } else {
        Write-Log "Scripts directory already exists: $scriptsDir" "INFO"
    }

    # ============================================================================
    # WINDOWS APPS REMOVAL
    # ============================================================================

    # Create BloatRemoval.ps1 script
    $bloatRemovalContent = @'
<#
  .SYNOPSIS
      Removes Windows bloatware apps, legacy capabilities, and optional features from Windows 10/11 systems.

  .DESCRIPTION
      This script removes selected Windows components including:
      - Appx packages (UWP apps like Calculator, Weather, etc.)
      - Legacy Windows capabilities
      - Optional Windows features
      - Special apps requiring custom uninstall procedures (e.g., OneNote)

      The script includes retry logic and verification to ensure complete removal.
      This script is designed to run in any context: user sessions, SYSTEM account, or scheduled tasks.

  .NOTES
      Source: https://github.com/memstechtips/Winhance

      Requirements:
      - Windows 10/11
      - Administrator privileges (script will auto-elevate)
      - PowerShell 5.1 or higher
#>

# Check if script is running as Administrator
If (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]"Administrator")) {
    Try {
        Start-Process PowerShell.exe -ArgumentList ("-NoProfile -ExecutionPolicy Bypass -File `"{0}`"" -f $PSCommandPath) -Verb RunAs
        Exit
    }
    Catch {
        Write-Host "Failed to run as Administrator. Please rerun with elevated privileges."
        Exit
    }
}

# Setup logging
$logFolder = "C:\ProgramData\Winhance\Logs"
$logFile = "$logFolder\BloatRemovalLog.txt"

# Create log directory if it doesn't exist
if (!(Test-Path $logFolder)) {
    New-Item -ItemType Directory -Path $logFolder -Force | Out-Null
}

# Function to write to log file
function Write-Log {
    param (
        [string]$Message
    )
    
    # Check if log file exists and is over 500KB (512000 bytes)
    if ((Test-Path $logFile) -and (Get-Item $logFile).Length -gt 512000) {
        Remove-Item $logFile -Force -ErrorAction SilentlyContinue
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        "$timestamp - Log rotated - previous log exceeded 500KB" | Out-File -FilePath $logFile
    }
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$timestamp - $Message" | Out-File -FilePath $logFile -Append
    
    # Also output to console for real-time progress
    Write-Host $Message
}
Write-Log "Starting bloat removal process"

# Enable Remove-AppX -AllUsers compatibility aliases for this session
Write-Log "Setting up AppX compatibility aliases for this session..."
try {
    Set-Alias Get-AppPackageAutoUpdateSettings Get-AppxPackageAutoUpdateSettings -Scope Global -Force
    Set-Alias Remove-AppPackageAutoUpdateSettings Remove-AppxPackageAutoUpdateSettings -Scope Global -Force
    Set-Alias Set-AppPackageAutoUpdateSettings Set-AppxPackageAutoUpdateSettings -Scope Global -Force
    Set-Alias Reset-AppPackage Reset-AppxPackage -Scope Global -Force
    Set-Alias Add-MsixPackage Add-AppxPackage -Scope Global -Force
    Set-Alias Get-MsixPackage Get-AppxPackage -Scope Global -Force
    Set-Alias Remove-MsixPackage Remove-AppxPackage -Scope Global -Force
    Write-Log "AppX compatibility aliases created successfully"
} catch {
    Write-Log "Warning: Could not create some AppX aliases: $($_.Exception.Message)"
}

# Packages to remove
$packages = @(
    'Microsoft.Microsoft3DViewer'
    'Microsoft.MixedReality.Portal'
    'Microsoft.BingSearch'
    'Microsoft.BingNews'
    'Microsoft.BingWeather'
    'Microsoft.WindowsCamera'
    'Clipchamp.Clipchamp'
    'Microsoft.WindowsAlarms'
    'Microsoft.549981C3F5F10'
    'Microsoft.GetHelp'
    'Microsoft.Windows.DevHome'
    'MicrosoftCorporationII.MicrosoftFamily'
    'microsoft.windowscommunicationsapps'
    'Microsoft.SkypeApp'
    'MSTeams'
    'Microsoft.WindowsFeedbackHub'
    'Microsoft.WindowsMaps'
    'Microsoft.MicrosoftOfficeHub'
    'Microsoft.OutlookForWindows'
    'Microsoft.MSPaint'
    'Microsoft.Windows.Photos'
    'Microsoft.People'
    'Microsoft.PowerAutomateDesktop'
    'MicrosoftCorporationII.QuickAssist'
    'Microsoft.MicrosoftSolitaireCollection'
    'Microsoft.GamingApp'
    'Microsoft.XboxApp'
    'Microsoft.XboxIdentityProvider'
    'Microsoft.XboxGameOverlay'
    'Microsoft.Xbox.TCUI'
    'Microsoft.XboxGamingOverlay'
    'Microsoft.WindowsStore'
    'Microsoft.ZuneMusic'
    'Microsoft.ZuneVideo'
    'Microsoft.WindowsSoundRecorder'
    'Microsoft.MicrosoftStickyNotes'
    'Microsoft.Getstarted'
    'Microsoft.Todos'
    'Microsoft.YourPhone'
    'Microsoft.Copilot'
    'Microsoft.Windows.Ai.Copilot.Provider'
    'Microsoft.Copilot_8wekyb3d8bbwe'
    'Microsoft.Office.OneNote'
)

# Capabilities to remove
$capabilities = @(
    'Microsoft.Windows.PowerShell.ISE'
    'App.Support.QuickAssist'
    'App.StepsRecorder'
    'Microsoft.Windows.WordPad'
    'OpenSSH.Server'
)

# Optional Features to disable
$optionalFeatures = @(
    'Recall'
)

# Special apps requiring uninstall string execution
$specialApps = @(
    'OneNote'
)

$maxRetries = 3
$retryCount = 0

do {
    $retryCount++
    Write-Log "Standard removal attempt $retryCount of $maxRetries"

    Write-Log "Discovering all packages..."
    $allInstalledPackages = Get-AppxPackage -AllUsers -ErrorAction SilentlyContinue
    $allProvisionedPackages = Get-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue

    Write-Log "Processing packages..."
    $packagesToRemove = @()
    $provisionedPackagesToRemove = @()
    $notFoundPackages = @()

    foreach ($package in $packages) {
        $foundAny = $false

        $installedPackages = $allInstalledPackages | Where-Object { $_.Name -eq $package }
        if ($installedPackages) {
            Write-Log "Found installed package: $package"
            foreach ($pkg in $installedPackages) {
                Write-Log "Queuing installed package for removal: $($pkg.PackageFullName)"
                $packagesToRemove += $pkg.PackageFullName
            }
            $foundAny = $true
        }

        $provisionedPackages = $allProvisionedPackages | Where-Object { $_.DisplayName -eq $package }
        if ($provisionedPackages) {
            Write-Log "Found provisioned package: $package"
            foreach ($pkg in $provisionedPackages) {
                Write-Log "Queuing provisioned package for removal: $($pkg.PackageName)"
                $provisionedPackagesToRemove += $pkg.PackageName
            }
            $foundAny = $true
        }

        if (-not $foundAny) {
            $notFoundPackages += $package
        }
    }

    if ($notFoundPackages.Count -gt 0) {
        Write-Log "Packages not found: $($notFoundPackages -join ', ')"
    }

    if ($packagesToRemove.Count -gt 0) {
        Write-Log "Removing $($packagesToRemove.Count) installed packages in batch..."
        try {
            $packagesToRemove | ForEach-Object {
                Write-Log "Removing installed package: $_"
                Remove-AppxPackage -Package $_ -AllUsers -ErrorAction SilentlyContinue
            }
            Write-Log "Batch removal of installed packages completed"
        } catch {
            Write-Log "Error in batch removal of installed packages: $($_.Exception.Message)"
        }
    }

    if ($provisionedPackagesToRemove.Count -gt 0) {
        Write-Log "Removing $($provisionedPackagesToRemove.Count) provisioned packages..."
        foreach ($pkgName in $provisionedPackagesToRemove) {
            try {
                Write-Log "Removing provisioned package: $pkgName"
                Remove-AppxProvisionedPackage -Online -PackageName $pkgName -ErrorAction SilentlyContinue
            } catch {
                Write-Log "Error removing provisioned package $pkgName : $($_.Exception.Message)"
            }
        }
        Write-Log "Provisioned packages removal completed"
    }

    Write-Log "Processing capabilities..."
    foreach ($capability in $capabilities) {
        Write-Log "Checking capability: $capability"
        try {
            $matchingCapabilities = Get-WindowsCapability -Online | Where-Object { $_.Name -like "$capability*" -or $_.Name -like "$capability~~~~*" }

            if ($matchingCapabilities) {
                $foundInstalled = $false
                foreach ($existingCapability in $matchingCapabilities) {
                    if ($existingCapability.State -eq "Installed") {
                        $foundInstalled = $true
                        Write-Log "Removing capability: $($existingCapability.Name)"
                        Remove-WindowsCapability -Online -Name $existingCapability.Name -ErrorAction SilentlyContinue | Out-Null
                    }
                }

                if (-not $foundInstalled) {
                    Write-Log "Found capability $capability but it is not installed"
                }
            }
            else {
                Write-Log "No matching capabilities found for: $capability"
            }
        }
        catch {
            Write-Log "Error checking capability: $capability - $($_.Exception.Message)"
        }
    }

    Write-Log "Processing optional features..."
    if ($optionalFeatures.Count -gt 0) {
        $enabledFeatures = @()
        foreach ($feature in $optionalFeatures) {
            Write-Log "Checking feature: $feature"
            $existingFeature = Get-WindowsOptionalFeature -Online -FeatureName $feature -ErrorAction SilentlyContinue
            if ($existingFeature -and $existingFeature.State -eq "Enabled") {
                $enabledFeatures += $feature
            } else {
                Write-Log "Feature not found or not enabled: $feature"
            }
        }

        if ($enabledFeatures.Count -gt 0) {
            Write-Log "Disabling features: $($enabledFeatures -join ', ')"
            Disable-WindowsOptionalFeature -Online -FeatureName $enabledFeatures -NoRestart -ErrorAction SilentlyContinue | Out-Null
        }
    }

    Write-Log "Verifying removal results..."
    $remainingItems = @()

    $currentPackages = Get-AppxPackage -AllUsers -ErrorAction SilentlyContinue
    foreach ($package in $packages) {
        if ($currentPackages | Where-Object { $_.Name -eq $package }) {
            $remainingItems += $package
            Write-Log "Package still installed: $package"
        }
    }

    $currentCapabilities = Get-WindowsCapability -Online -ErrorAction SilentlyContinue | Where-Object State -eq 'Installed'
    foreach ($capability in $capabilities) {
        if ($currentCapabilities | Where-Object { $_.Name -like "$capability*" }) {
            $remainingItems += $capability
            Write-Log "Capability still installed: $capability"
        }
    }

    $currentFeatures = Get-WindowsOptionalFeature -Online -ErrorAction SilentlyContinue | Where-Object State -eq 'Enabled'
    foreach ($feature in $optionalFeatures) {
        if ($currentFeatures | Where-Object { $_.FeatureName -eq $feature }) {
            $remainingItems += $feature
            Write-Log "Feature still enabled: $feature"
        }
    }

    if ($remainingItems.Count -eq 0) {
        Write-Log "All standard items successfully removed!"
        break
    } else {
        Write-Log "Retry needed. $($remainingItems.Count) items remain: $($remainingItems -join ', ')"
        if ($retryCount -lt $maxRetries) {
            Write-Log "Waiting 2 seconds before retry..."
            Start-Sleep -Seconds 2
        }
    }

} while ($retryCount -lt $maxRetries -and $remainingItems.Count -gt 0)

if ($remainingItems.Count -gt 0) {
    Write-Log "Warning: $($remainingItems.Count) standard items could not be removed after $maxRetries attempts: $($remainingItems -join ', ')"
}

if ($specialApps.Count -gt 0) {
    Write-Log "Processing special apps that require custom uninstall procedures..."

    $maxSpecialRetries = 2
    $specialRetryCount = 0
    $specialAppsRemaining = @()

    do {
        $specialRetryCount++
        if ($specialRetryCount -gt 1) {
            Write-Log "Special apps retry attempt $specialRetryCount of $maxSpecialRetries"
        }

        $uninstallBasePaths = @(
            'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall',
            'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall'
        )

        foreach ($specialApp in $specialApps) {
            Write-Log "Processing special app: $specialApp"

            switch ($specialApp) {
                'OneNote' {
                    $processesToStop = @('OneNote', 'ONENOTE', 'ONENOTEM')
                    $searchPattern = 'OneNote*'
                    $packagePattern = '*OneNote*'
                }
                default {
                    Write-Log "Unknown or unsupported special app: $specialApp"
                    continue
                }
            }

            foreach ($processName in $processesToStop) {
                $processes = Get-Process -Name $processName -ErrorAction SilentlyContinue
                if ($processes) {
                    $processes | Stop-Process -Force -ErrorAction SilentlyContinue
                    Write-Log "Stopped process: $processName"
                }
            }

            $uninstallExecuted = $false
            foreach ($uninstallBasePath in $uninstallBasePaths) {
                try {
                    Write-Log "Searching for $searchPattern in $uninstallBasePath"
                    $uninstallKeys = Get-ChildItem -Path $uninstallBasePath -ErrorAction SilentlyContinue |
                                    Where-Object { $_.PSChildName -like $searchPattern }

                    foreach ($key in $uninstallKeys) {
                        try {
                            $uninstallString = (Get-ItemProperty -Path $key.PSPath -ErrorAction SilentlyContinue).UninstallString
                            if ($uninstallString) {
                                Write-Log "Found uninstall string: $uninstallString"

                                if ($uninstallString -match '^\"([^\"]+)\"(.*)$') {
                                    $exePath = $matches[1]
                                    $args = $matches[2].Trim()

                                    if ($exePath -like '*OfficeClickToRun.exe') {
                                        $args += ' DisplayLevel=False'
                                    } else {
                                        $args += ' /silent'
                                    }

                                    Write-Log "Executing: $exePath with args: $args"
                                    Start-Process -FilePath $exePath -ArgumentList $args -NoNewWindow -Wait -ErrorAction SilentlyContinue
                                } else {
                                    if ($uninstallString -like '*OfficeClickToRun.exe*') {
                                        Start-Process -FilePath $uninstallString -ArgumentList 'DisplayLevel=False' -NoNewWindow -Wait -ErrorAction SilentlyContinue
                                    } else {
                                        Start-Process -FilePath $uninstallString -ArgumentList '/silent' -NoNewWindow -Wait -ErrorAction SilentlyContinue
                                    }
                                }

                                $uninstallExecuted = $true
                                Write-Log "Completed uninstall execution for $specialApp"
                            }
                        }
                        catch {
                            Write-Log "Error processing uninstall key: $($_.Exception.Message)"
                        }
                    }
                }
                catch {
                    Write-Log "Error searching for uninstall keys: $($_.Exception.Message)"
                }
            }

            if (-not $uninstallExecuted) {
                Write-Log "No uninstall strings found for $specialApp"
            }
        }

        if ($specialRetryCount -eq 1) {
            Write-Log "Waiting 3 seconds for uninstallers to complete..."
            Start-Sleep -Seconds 3
        }

        Write-Log "Verifying special apps removal..."
        $specialAppsRemaining = @()

        foreach ($specialApp in $specialApps) {
            $stillExists = $false

            switch ($specialApp) {
                'OneNote' {
                    $appxPackage = Get-AppxPackage -AllUsers -ErrorAction SilentlyContinue |
                                   Where-Object { $_.Name -like '*OneNote*' }
                    if ($appxPackage) {
                        $stillExists = $true
                        Write-Log "OneNote AppxPackage still exists: $($appxPackage.PackageFullName)"
                    }

                    $uninstallKeys = Get-ChildItem -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall' -ErrorAction SilentlyContinue |
                                     Where-Object { $_.PSChildName -like 'OneNote*' }
                    if ($uninstallKeys) {
                        $stillExists = $true
                        Write-Log "OneNote registry uninstall keys still exist"
                    }
                }
            }

            if ($stillExists) {
                $specialAppsRemaining += $specialApp
            }
        }

        if ($specialAppsRemaining.Count -eq 0) {
            Write-Log "All special apps successfully removed!"
            break
        } else {
            Write-Log "$($specialAppsRemaining.Count) special apps remain: $($specialAppsRemaining -join ', ')"
            if ($specialRetryCount -lt $maxSpecialRetries) {
                Write-Log "Waiting 3 seconds before retry..."
                Start-Sleep -Seconds 3
            }
        }

    } while ($specialRetryCount -lt $maxSpecialRetries -and $specialAppsRemaining.Count -gt 0)

    if ($specialAppsRemaining.Count -gt 0) {
        Write-Log "Warning: $($specialAppsRemaining.Count) special apps could not be removed after $maxSpecialRetries attempts: $($specialAppsRemaining -join ', ')"
    }
}


# ============================================================================
# REGISTRY SETTINGS TO PREVENT ISSUES AND BUGS
# ============================================================================

$xboxPackages = @('Microsoft.GamingApp', 'Microsoft.XboxGamingOverlay', 'Microsoft.XboxGameOverlay')
$hasXboxPackages = $packages | Where-Object { $xboxPackages -contains $_ }

if ($hasXboxPackages) {
    Write-Log "Applying registry settings to prevent post-removal issues..."

    try {
        $runningAsSystem = ($env:USERNAME -eq "SYSTEM" -or $env:USERPROFILE -like "*\system32\config\systemprofile")

        if ($runningAsSystem) {
            Write-Log "Running as SYSTEM - detecting logged-in user..."
            $loggedInUser = (Get-WmiObject -Class Win32_ComputerSystem -ErrorAction SilentlyContinue).UserName

            if ($loggedInUser -and $loggedInUser -ne "NT AUTHORITY\SYSTEM") {
                $username = $loggedInUser.Split('\\')[1]
                try {
                    $sid = (New-Object System.Security.Principal.NTAccount($username)).Translate([System.Security.Principal.SecurityIdentifier]).Value
                    Write-Log "Applying settings for user: $username (SID: $sid)"

                    reg add "HKU\$sid\SOFTWARE\Microsoft\Windows\CurrentVersion\GameDVR" /f /t REG_DWORD /v "AppCaptureEnabled" /d 0 2>$null | Out-Null
                    reg add "HKU\$sid\System\GameConfigStore" /f /t REG_DWORD /v "GameDVR_Enabled" /d 0 2>$null | Out-Null

                    Write-Log "Xbox Game DVR registry settings applied successfully"
                } catch {
                    Write-Log "Warning: Could not apply Xbox Game DVR registry settings: $($_.Exception.Message)"
                }
            } else {
                Write-Log "Warning: Could not detect logged-in user for registry settings"
            }
        } else {
            Write-Log "Running as user - applying settings directly to HKCU"
            reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\GameDVR" /f /t REG_DWORD /v "AppCaptureEnabled" /d 0 2>$null | Out-Null
            reg add "HKCU\System\GameConfigStore" /f /t REG_DWORD /v "GameDVR_Enabled" /d 0 2>$null | Out-Null
            Write-Log "Xbox Game DVR registry settings applied successfully"
        }
    } catch {
        Write-Log "Warning: Could not apply Xbox Game DVR registry settings: $($_.Exception.Message)"
    }
}


Write-Log "Bloat removal process completed"
'@

    $bloatRemovalPath = Join-Path $scriptsDir "BloatRemoval.ps1"
    try {
        $bloatRemovalContent | Out-File -FilePath $bloatRemovalPath -Encoding UTF8 -Force
        Write-Log "Created: BloatRemoval.ps1" "SUCCESS"
    } catch {
        Write-Log "Failed to create BloatRemoval.ps1: $($_.Exception.Message)" "ERROR"
    }

    # Create EdgeRemoval.ps1 script
    $edgeRemovalContent = @'

<#
  .SYNOPSIS
      Removes Microsoft Edge (Legacy and Chromium versions) from Windows 10/11 systems.

  .DESCRIPTION
      This script detects and removes Microsoft Edge installations including:
      - Legacy UWP Edge (pre-Chromium)
      - Chromium-based Edge (current version)
      - EdgeUpdate components
      - EdgeWebView2 is NOT removed

      This script is designed to run in any context: user sessions, SYSTEM account, or scheduled tasks.

  .NOTES
      Source: https://github.com/memstechtips/Winhance

      Requirements:
      - Windows 10/11
      - Administrator privileges (script will auto-elevate)
      - PowerShell 5.1 or higher

      Credits:
      - Legacy Edge removal based on work by ishad0w: https://gist.github.com/ishad0w/d25ca52eb04dbefba8087a344a69c79c
      - Chromium Edge removal based on work by FR33THY: https://github.com/FR33THYFR33THY/Ultimate-Windows-Optimization-Guide/blob/main/6%20Windows/14%20Edge.ps1
      - Edge protocol redirect based on OpenWebSearch by AveYo: https://github.com/AveYo/fox/blob/main/OpenWebSearch.cmd
#>

# Check if script is running as Administrator
If (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]"Administrator")) {
    Try {
        Start-Process PowerShell.exe -ArgumentList ("-NoProfile -ExecutionPolicy Bypass -File `"{0}`"" -f $PSCommandPath) -Verb RunAs
        Exit
    }
    Catch {
        Write-Host "Failed to run as Administrator. Please rerun with elevated privileges."
        Exit
    }
}

# Setup logging
$logFolder = "C:\ProgramData\Winhance\Logs"
$logFile = "$logFolder\EdgeRemovalLog.txt"

# Create log directory if it doesn't exist
if (!(Test-Path $logFolder)) {
    New-Item -ItemType Directory -Path $logFolder -Force | Out-Null
}

# Function to write to log file
function Write-Log {
    param (
        [string]$Message
    )

    # Check if log file exists and is over 500KB (512000 bytes)
    if ((Test-Path $logFile) -and (Get-Item $logFile).Length -gt 512000) {
        Remove-Item $logFile -Force -ErrorAction SilentlyContinue
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        "$timestamp - Log rotated - previous log exceeded 500KB" | Out-File -FilePath $logFile
    }

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$timestamp - $Message" | Out-File -FilePath $logFile -Append

    # Also output to console for real-time progress
    Write-Host $Message
}

# Helper function to get Legacy Edge packages
function Get-LegacyEdgePackages {
    $legacyRegPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing\Packages"
    return Get-ChildItem -Path $legacyRegPath -Name -ErrorAction SilentlyContinue | Where-Object { $_ -match "Microsoft-Windows-Internet-Browser-Package" -and $_ -match "~~" }
}

# Function to test if Legacy Edge is installed
function Test-LegacyEdgeInstalled {
    $packages = Get-LegacyEdgePackages

    if ($packages) {
        foreach ($package in $packages) {
            $packageInfo = & dism /online /Get-PackageInfo /PackageName:$package 2>$null
            if ($packageInfo -match "State.*Installed") {
                return $true
            }
        }
    }
    return $false
}

# Function to test if Chromium Edge is installed
function Test-ChromiumEdgeInstalled {
    # Check folders first (fastest)
    $edgeFolders = @("Edge", "EdgeCore", "EdgeUpdate")
    $programFiles = @($env:ProgramFiles, ${env:ProgramFiles(x86)})

    foreach ($pf in $programFiles) {
        foreach ($folder in $edgeFolders) {
            if (Test-Path "$pf\Microsoft\$folder") {
                return $true
            }
        }
    }

    # Fallback: Check installed programs
    try {
        $edgeApp = Get-WmiObject -Class Win32_InstalledStoreProgram -Filter "Name like '%Microsoft.MicrosoftEdge.Stable%'" -ErrorAction SilentlyContinue
        return $edgeApp -ne $null
    } catch {
        return $false
    }
}

# Function to stop Edge-related processes
function Stop-EdgeProcesses {
    Write-Log "Stopping Edge-related processes and services"
    $stop = "MicrosoftEdgeUpdate", "OneDrive", "WidgetService", "Widgets", "msedge", "Resume", "CrossDeviceResume", "msedgewebview2"
    $stop | ForEach-Object {
        $processCount = (Get-Process -Name $_ -ErrorAction SilentlyContinue).Count
        if ($processCount -gt 0) {
            Stop-Process -Name $_ -Force -ErrorAction SilentlyContinue
            Write-Log "Stopped $processCount instance(s) of $_"
        }
    }
}

# Function to remove Legacy Edge
function Remove-LegacyEdge {
    Write-Log "Starting Legacy Edge/UWP Edge removal process"
    # Query registry for Edge Legacy package
    $packages = Get-LegacyEdgePackages
    $edgeLegacyPackageVersion = $packages | Select-Object -First 1
    $packagePath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing\Packages\$edgeLegacyPackageVersion"
    # Set registry visibility
    Set-ItemProperty -Path $packagePath -Name "Visibility" -Value 1 -Type DWord -Force -ErrorAction SilentlyContinue
    # Remove owners registry entries
    $ownersPath = "$packagePath\Owners"
    if (Test-Path $ownersPath) { Remove-Item -Path $ownersPath -Recurse -Force -ErrorAction SilentlyContinue }
    Write-Log "Removing Legacy Edge package via DISM (with 30-second timeout)"
    $dismProcess = Start-Process -FilePath "dism.exe" -ArgumentList "/online", "/Remove-Package", "/PackageName:$edgeLegacyPackageVersion" -NoNewWindow -PassThru

    if ($dismProcess -and $dismProcess.WaitForExit(30000)) {
        Write-Log "DISM completed successfully"
    } elseif ($dismProcess) {
        Write-Log "DISM timed out after 30 seconds, killing process and retrying once"
        $dismProcess.Kill()
        Start-Sleep 2

        # Retry once
        Write-Log "Retrying DISM command"
        $retryProcess = Start-Process -FilePath "dism.exe" -ArgumentList "/online", "/Remove-Package", "/PackageName:$edgeLegacyPackageVersion" -NoNewWindow -PassThru

        if ($retryProcess -and $retryProcess.WaitForExit(30000)) {
            Write-Log "DISM retry completed successfully"
        } elseif ($retryProcess) {
            Write-Log "DISM retry also timed out, continuing with script"
            $retryProcess.Kill()
        } else {
            Write-Log "DISM retry failed to start, continuing with script"
        }
    } else {
        Write-Log "DISM failed to start, continuing with script"
    }
    # Remove Legacy UWP Edge package
    Write-Log "Removing Legacy UWP Edge package"
    Get-AppxPackage Microsoft.MicrosoftEdge | Remove-AppxPackage -ErrorAction SilentlyContinue | Out-Null
    Write-Log "Legacy Edge/UWP Edge removal process completed"
}

# Function to remove Edge shortcuts
function Remove-EdgeShortcuts {
    Write-Log "Starting Edge shortcuts cleanup"

    # Get ALL user profiles (no exclusions)
    $userProfiles = Get-ChildItem -Path "C:\Users" -Directory | Where-Object {
        (Test-Path -Path "$($_.FullName)\NTUSER.DAT")
    }

    # Build all shortcut paths to check
    $shortcutPaths = @()

    # Add user-specific paths (now includes Public, Default, etc.)
    foreach ($profile in $userProfiles) {
        $shortcutPaths += @(
            "$($profile.FullName)\AppData\Roaming\Microsoft\Internet Explorer\Quick Launch\Microsoft Edge.lnk",
            "$($profile.FullName)\Desktop\Microsoft Edge.lnk",
            "$($profile.FullName)\AppData\Roaming\Microsoft\Internet Explorer\Quick Launch\User Pinned\TaskBar\Microsoft Edge.lnk",
            "$($profile.FullName)\AppData\Roaming\Microsoft\Internet Explorer\Quick Launch\User Pinned\TaskBar\Tombstones\Microsoft Edge.lnk",
            "$($profile.FullName)\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Microsoft Edge.lnk"
        )
    }

    # Add the single ProgramData path
    $shortcutPaths += "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Microsoft Edge.lnk"

    # Remove all shortcuts in one loop
    $removedCount = 0
    foreach ($path in $shortcutPaths) {
        if (Test-Path -Path $path -PathType Leaf) {
            Remove-Item -Path $path -Force -ErrorAction SilentlyContinue
            $removedCount++
        }
    }

    Write-Log "Removed $removedCount Edge shortcut(s)"
}

function Install-EdgeProtocolRedirect {
    Write-Log "Checking if Edge protocol redirect is needed"

    $ifeoCheck = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ie_to_edge_stub.exe\0"
    if (Test-Path $ifeoCheck) {
        $debugger = (Get-ItemProperty -Path $ifeoCheck -Name "Debugger" -ErrorAction SilentlyContinue).Debugger
        if ($debugger -like "*OpenWebSearch*") {
            Write-Log "Edge protocol redirect already installed"
            return
        }
    }

    Write-Log "Installing Edge protocol redirect using OpenWebSearch"
    $scriptsDir = "C:\ProgramData\Winhance\OpenWebSearch"
    New-Item -ItemType Directory -Path $scriptsDir -Force -ErrorAction SilentlyContinue | Out-Null

    $stubTargetPath = "$scriptsDir\ie_to_edge_stub.exe"
    if (!(Test-Path $stubTargetPath)) {
        Write-Log "Warning: ie_to_edge_stub.exe not found at $stubTargetPath (should have been copied before Edge removal)"
        return
    }

    $openWebSearchContent = @"
@title OpenWebSearch 2023 & echo off
for /f %%E in ('"prompt `$E`$S& for %%e in (1) do rem"') do echo;%%E[2t 2>nul

call :reg_var "HKCU\SOFTWARE\Microsoft\Windows\Shell\Associations\UrlAssociations\https\UserChoice" ProgID ProgID
if /i "%ProgID%" equ "MSEdgeHTM" exit /b

call :reg_var "HKCR\%ProgID%\shell\open\command" "" Browser
set Choice=& for %%. in (%Browser%) do if not defined Choice set "Choice=%%~."

call :reg_var "HKCR\MSEdgeMHT\shell\open\command" "" FallBack
set "Edge=" & for %%. in (%FallBack%) do if not defined Edge set "Edge=%%~."
set "URI=" & set "URL=" & set "NOOP=" & set "PassTrough=%Edge:msedge=edge%"

set "CLI=%CMDCMDLINE:"=````%"
if defined CLI set "CLI=%CLI:*ie_to_edge_stub.exe```` =%"
if defined CLI set "CLI=%CLI:*ie_to_edge_stub.exe =%"
if defined CLI set "CLI=%CLI:*msedge.exe```` =%"
if defined CLI set "CLI=%CLI:*msedge.exe =%"
set "FIX=%CLI:~-1%"
if defined CLI if "%FIX%"==" " set "CLI=%CLI:~0,-1%"
if defined CLI set "RED=%CLI:microsoft-edge=%"
if defined CLI set "URL=%CLI:http=%"
if defined CLI set "ARG=%CLI:````="%"

if "%CLI%" equ "%RED%" (set NOOP=1) else if "%CLI%" equ "%URL%" (set NOOP=1)
if defined NOOP if not exist "%PassTrough%" echo;@mklink /h "%PassTrough%" "%Edge%" >"%Temp%\OpenWebSearchRepair.cmd"
if defined NOOP if not exist "%PassTrough%" schtasks /run /tn OpenWebSearchRepair 2>nul >nul
if defined NOOP if not exist "%PassTrough%" timeout /t 3 >nul
if defined NOOP if exist "%PassTrough%" start "" "%PassTrough%" %ARG%
if defined NOOP exit /b

set "URL=%CLI:*microsoft-edge=%"
set "URL=http%URL:*http=%"
set "FIX=%URL:~-2%"
if defined URL if "%FIX%"=="````" set "URL=%URL:~0,-2%"
call :dec_url
start "" "%Choice%" "%URL%"
exit

:reg_var
set {var}=& set {reg}=reg query "%~1" /v %2 /z /se "," /f /e& if %2=="" set {reg}=reg query "%~1" /ve /z /se "," /f /e
for /f "skip=2 tokens=* delims=" %%V in ('%{reg}% %4 %5 %6 %7 %8 %9 2^>nul') do if not defined {var} set "{var}=%%V"
if not defined {var} (set {reg}=& set "%~3="& exit /b) else if %2=="" set "{var}=%{var}:*)    =%"
if not defined {var} (set {reg}=& set "%~3="& exit /b) else set {reg}=& set "%~3=%{var}:*)    =%"& set {var}=& exit /b

:dec_url
set ".=%URL:!=}%" & setlocal enabledelayedexpansion
set ".=!.:%%={!" &set ".=!.:{3A=:!" &set ".=!.:{2F=/!" &set ".=!.:{3F=?!" &set ".=!.:{23=#!" &set ".=!.:{5B=[!" &set ".=!.:{5D=]!"
set ".=!.:{40=@!"&set ".=!.:{21=}!" &set ".=!.:{24=`$!" &set ".=!.:{26=&!" &set ".=!.:{27='!" &set ".=!.:{28=(!" &set ".=!.:{29=)!"
set ".=!.:{2A=*!"&set ".=!.:{2B=+!" &set ".=!.:{2C=,!" &set ".=!.:{3B=;!" &set ".=!.:{3D==!" &set ".=!.:{25=%%!"&set ".=!.:{20= !"
set ".=!.:{=%%!" & endlocal& set "URL=%.:}=!%" & exit /b
"@

    $openWebSearchPath = "$scriptsDir\OpenWebSearch.cmd"
    $openWebSearchContent | Out-File -FilePath $openWebSearchPath -Encoding ASCII -Force
    Write-Log "Created OpenWebSearch.cmd at $openWebSearchPath"

    $msedgePath = "${env:ProgramFiles(x86)}\Microsoft\Edge\Application\msedge.exe"
    $edgePath = "${env:ProgramFiles(x86)}\Microsoft\Edge\Application\edge.exe"
    if ((Test-Path $msedgePath) -and !(Test-Path $edgePath)) {
        cmd /c mklink /h "$edgePath" "$msedgePath" 2>&1 | Out-Null
        Write-Log "Created edge.exe hardlink at $edgePath"
    }

    $buildNumber = [Environment]::OSVersion.Version.Build
    $conhostFlags = if ($buildNumber -gt 25179) { "--width 1 --height 1" } else { "--headless" }
    $conhostDebugger = "$env:SystemRoot\system32\conhost.exe $conhostFlags $scriptsDir\OpenWebSearch.cmd"

    Write-Log "Configuring registry entries for Edge protocol redirect"
    reg.exe add "HKCR\microsoft-edge" /f /ve /d "URL:microsoft-edge" 2>&1 | Out-Null
    reg.exe add "HKCR\microsoft-edge" /f /v "URL Protocol" /d `"`" 2>&1 | Out-Null
    reg.exe add "HKCR\microsoft-edge" /f /v "NoOpenWith" /d `"`" 2>&1 | Out-Null
    reg.exe add "HKCR\microsoft-edge\shell\open\command" /f /ve /d "$stubTargetPath %1" 2>&1 | Out-Null
    reg.exe add "HKCR\MSEdgeHTM" /f /v "NoOpenWith" /d `"`" 2>&1 | Out-Null
    reg.exe add "HKCR\MSEdgeHTM\shell\open\command" /f /ve /d "$stubTargetPath %1" 2>&1 | Out-Null
    reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ie_to_edge_stub.exe" /f /v UseFilter /d 1 /t reg_dword 2>&1 | Out-Null
    reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ie_to_edge_stub.exe\0" /f /v FilterFullPath /d "$stubTargetPath" 2>&1 | Out-Null
    reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\ie_to_edge_stub.exe\0" /f /v Debugger /d "$conhostDebugger" 2>&1 | Out-Null
    reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\msedge.exe" /f /v UseFilter /d 1 /t reg_dword 2>&1 | Out-Null
    reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\msedge.exe\0" /f /v FilterFullPath /d "$msedgePath" 2>&1 | Out-Null
    reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\msedge.exe\0" /f /v Debugger /d "$conhostDebugger" 2>&1 | Out-Null
    Write-Log "Registry configuration completed"

    $repairScriptPath = "$scriptsDir\OpenWebSearchRepair.cmd"
    $repairScriptContent = "@echo off`r`nmklink /h ""$edgePath"" ""$msedgePath"""
    $repairScriptContent | Out-File -FilePath $repairScriptPath -Encoding ASCII -Force
    Write-Log "Created repair script at $repairScriptPath"

    Write-Log "Creating OpenWebSearchRepair scheduled task"
    try {
        $taskAction = New-ScheduledTaskAction -Execute $repairScriptPath
        $taskTrigger = New-ScheduledTaskTrigger -Once -At (Get-Date).Date
        $taskSettings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
        Register-ScheduledTask -TaskName 'OpenWebSearchRepair' -Action $taskAction -Trigger $taskTrigger -Settings $taskSettings -RunLevel Highest -Force | Out-Null
        Write-Log "OpenWebSearchRepair scheduled task created"
    } catch {
        Write-Log "Failed to create OpenWebSearchRepair scheduled task: $($_.Exception.Message)"
    }
}

# Function to remove Chromium Edge and EdgeUpdate
function Remove-ChromiumEdge {
    # Remove Chromium Edge
    Write-Log "Starting Edge Chromium uninstallation process"
    # Folder and file to allow uninstall of Edge Chromium Browser
    Write-Log "Creating temporary directory for Edge uninstallation"
    $edgePath = "$env:SystemRoot\SystemApps\Microsoft.MicrosoftEdge_8wekyb3d8bbwe"
    New-Item -Path $edgePath -ItemType Directory -ErrorAction SilentlyContinue | Out-Null
    New-Item -Path $edgePath -ItemType File -Name "MicrosoftEdge.exe" -ErrorAction SilentlyContinue | Out-Null
    # Get Edge Uninstall Strings for Enterprise MSI version or normal version (they require different handling)
    Write-Log "Searching for Edge uninstall strings in registry"
    $uninstallKeys = Get-ChildItem "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
    $edgeUninstallCount = 0
    foreach ($key in $uninstallKeys) {
        $displayName = (Get-ItemProperty $key.PSPath -ErrorAction SilentlyContinue).DisplayName
        if ($displayName -like "*Microsoft Edge*") {
            $uninstallString = (Get-ItemProperty $key.PSPath).UninstallString
            if ($uninstallString) {
                $edgeUninstallCount++
                if ($uninstallString -like "*msiexec*") {
                    # Uninstalls Enterprise MSI version
                    Write-Log "Executing MSI uninstaller for Edge"
                    Start-Process cmd.exe "/c $uninstallString /quiet" -WindowStyle Hidden -Wait | Out-Null
                } else {
                    # Uninstalls normal version
                    Write-Log "Executing standard uninstaller for Edge"
                    Start-Process cmd.exe "/c $uninstallString --force-uninstall --silent" -WindowStyle Hidden -Wait | Out-Null
                }
            }
        }
    }
    if ($edgeUninstallCount -eq 0) {
        Write-Log "No Edge uninstall entries found in registry"
    } else {
        Write-Log "Executed $edgeUninstallCount Edge uninstaller(s)"
    }
    # Remove UWP Edge Chromium package
    Write-Log "Removing UWP Edge Chromium package"
    Get-AppxPackage *Microsoft.MicrosoftEdge.Stable* | Remove-AppxPackage -ErrorAction SilentlyContinue | Out-Null
    # Cleanup: Remove folder and file we created earlier
    Write-Log "Cleaning up temporary Edge directory"
    Remove-Item -Recurse -Force $edgePath -ErrorAction SilentlyContinue | Out-Null
    Write-Log "Edge Chromium uninstallation process completed"

    # Remove EdgeUpdate
    Write-Log "Starting EdgeUpdate removal process"
    # Find EdgeUpdate executables
    Write-Log "Searching for EdgeUpdate executables"
    $edgeupdate = @()
    $searchPaths = @("LocalApplicationData", "ProgramFilesX86", "ProgramFiles")
    foreach ($pathType in $searchPaths) {
        $folder = [Environment]::GetFolderPath($pathType)
        $searchPattern = "$folder\Microsoft\EdgeUpdate\*.*.*.*\MicrosoftEdgeUpdate.exe"
        $foundFiles = Get-ChildItem $searchPattern -Recurse -ErrorAction SilentlyContinue
        if ($foundFiles) {
            $edgeupdate += $foundFiles.FullName
        }
    }
    if ($edgeupdate.Count -gt 0) {
        Write-Log "Found $($edgeupdate.Count) EdgeUpdate executable(s)"
    } else {
        Write-Log "No EdgeUpdate executables found"
    }
    # Backup ClientState registry if it exists (important, or else webview won't work)
    $backupRegFile = "$env:TEMP\EdgeUpdate_ClientState_Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').reg"
    $clientStatePath = "HKLM:\SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\ClientState"
    if (Test-Path $clientStatePath) {
        Write-Log "Backing up EdgeUpdate ClientState registry"
        cmd /c "reg export `"HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\ClientState`" `"$backupRegFile`" /y" 2>$null
        if (Test-Path $backupRegFile) {
            Write-Log "Successfully created registry backup at $backupRegFile"
        } else {
            Write-Log "Warning: Failed to create registry backup"
        }
    } else {
        Write-Log "No EdgeUpdate ClientState registry found to backup"
    }
    # Clean registry entries
    Write-Log "Removing EdgeUpdate registry entries"
    $registryPaths = @(
        "HKLM:\SOFTWARE", "HKLM:\SOFTWARE\Policies", "HKLM:\SOFTWARE\WOW6432Node", "HKLM:\SOFTWARE\WOW6432Node\Policies"
    )
    $removedRegCount = 0
    foreach ($location in $registryPaths) {
        $regPath = "$location\Microsoft\EdgeUpdate"
        if (Test-Path $regPath) {
            Remove-Item $regPath -Recurse -Force -ErrorAction SilentlyContinue
            $removedRegCount++
        }
    }
    Write-Log "Removed EdgeUpdate registry entries from $removedRegCount location(s)"
    # Uninstall EdgeUpdate executables
    Write-Log "Processing EdgeUpdate uninstallation"
    foreach ($path in $edgeupdate) {
        if (Test-Path $path) {
            # Unregister service
            Write-Log "Unregistering EdgeUpdate service from $path"
            Start-Process -FilePath $path -ArgumentList "/unregsvc" -Wait -WindowStyle Hidden -ErrorAction SilentlyContinue
            # Wait for processes to finish
            $waitCount = 0
            do {
                Start-Sleep 3
                $runningProcesses = Get-Process -Name "setup", "MicrosoftEdge*" -ErrorAction SilentlyContinue | Where-Object { $_.Path -like "*\Microsoft\Edge*" }
            } while ($runningProcesses -and $waitCount++ -lt 20)
            # Run uninstall if file still exists
            if (Test-Path $path) {
                Write-Log "Running EdgeUpdate uninstaller from $path"
                Start-Process -FilePath $path -ArgumentList "/uninstall" -Wait -WindowStyle Hidden -ErrorAction SilentlyContinue
            }
        }
    }
    # Restore ClientState backup
    if ((Test-Path $backupRegFile)) {
        Write-Log "Restoring EdgeUpdate ClientState registry from backup"
        cmd /c "reg import `"$backupRegFile`"" 2>$null
        Remove-Item $backupRegFile -ErrorAction SilentlyContinue
        Write-Log "Registry restore completed and backup file cleaned up"
    } else {
        Write-Log "No registry backup file found to restore"
    }
    Write-Log "EdgeUpdate removal process completed"
}

Write-Host "Starting Edge removal process. See $logFile for details."

# Check for Edge installations first
Write-Log "Checking for Edge installations..."

$legacyInstalled = Test-LegacyEdgeInstalled
$chromiumInstalled = Test-ChromiumEdgeInstalled

if (-not $legacyInstalled -and -not $chromiumInstalled) {
    Write-Log "No Edge installations detected. Exiting."
    Write-Host "No Edge installations found. Script exiting."
    exit 0
}

$removedSomething = $false
$stubPath = $null

if ($chromiumInstalled) {
    Write-Log "Chromium Edge detected. Finding ie_to_edge_stub.exe before removal."

    $stubLocations = @("$env:ProgramData\ie_to_edge_stub.exe", "$env:Public\ie_to_edge_stub.exe")
    foreach ($loc in $stubLocations) {
        if (Test-Path $loc) {
            $stubPath = $loc
            Write-Log "Found stub at: $loc"
            break
        }
    }

    if (!$stubPath) {
        $stubSearch = Get-ChildItem "${env:ProgramFiles(x86)}\Microsoft\Edge" -Filter "ie_to_edge_stub.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($stubSearch) {
            $stubPath = $stubSearch.FullName
            Write-Log "Found stub at: $stubPath"
        } else {
            Write-Log "ie_to_edge_stub.exe not found in any location"
        }
    }

    if ($stubPath) {
        $scriptsDir = "C:\ProgramData\Winhance\OpenWebSearch"
        New-Item -ItemType Directory -Path $scriptsDir -Force -ErrorAction SilentlyContinue | Out-Null
        Copy-Item $stubPath "$scriptsDir\ie_to_edge_stub.exe" -Force -ErrorAction SilentlyContinue
        Write-Log "Copied ie_to_edge_stub.exe to $scriptsDir before Edge removal"
    }
}

if ($legacyInstalled) {
    Write-Log "Legacy Edge detected. Proceeding with removal."
    Stop-EdgeProcesses
    Remove-LegacyEdge
    $removedSomething = $true
}

if ($chromiumInstalled) {
    Write-Log "Chromium Edge detected. Proceeding with removal."
    Stop-EdgeProcesses
    Remove-ChromiumEdge
    $removedSomething = $true
}

# Only do cleanup if we removed something
if ($removedSomething) {
    # Cleanup: Remove folders containing Edge (Edge, EdgeCore, EdgeUpdate) or Temp but exclude EdgeWebView
    Write-Log "Starting cleanup of Microsoft Edge folders"
    $edgeFolders = Get-ChildItem -Path "$env:SystemDrive\Program Files (x86)\Microsoft" -Directory -ErrorAction SilentlyContinue |
    Where-Object { ($_.Name -like "*Edge*" -or $_.Name -like "*Temp*") -and $_.Name -notlike "*EdgeWebView*" }
    if ($edgeFolders) {
        Write-Log "Found $($edgeFolders.Count) Edge-related folder(s) to remove"
        $edgeFolders | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Write-Log "Cleanup of Microsoft Edge folders completed"
    } else {
        Write-Log "No Edge-related folders found to clean up"
    }

    Remove-EdgeShortcuts
    Install-EdgeProtocolRedirect
}

# Always check for and delete Edge scheduled tasks
Write-Log "Checking for Edge scheduled tasks"
try {
    $edgeTasks = Get-ScheduledTask -TaskName "*Edge*" -ErrorAction SilentlyContinue
    if ($edgeTasks) {
        foreach ($task in $edgeTasks) {
            # Skip the EdgeRemoval task
            if ($task.TaskName -eq "EdgeRemoval") {
                Write-Log "Skipping EdgeRemoval task: $($task.TaskName)"
                continue
            }
            
            Write-Log "Found Edge scheduled task: $($task.TaskName) - State: $($task.State)"
            try {
                Unregister-ScheduledTask -TaskName $task.TaskName -TaskPath $task.TaskPath -Confirm:$false -ErrorAction SilentlyContinue
                Write-Log "Deleted scheduled task: $($task.TaskName)"
            }
            catch {
                Write-Log "Failed to delete scheduled task: $($task.TaskName) - $($_.Exception.Message)"
            }
        }
    } else {
        Write-Log "No Edge scheduled tasks found"
    }
}
catch {
    Write-Log "Failed to check scheduled tasks: $($_.Exception.Message)"
}

Write-Log "Done."
Write-Host "Done. See $logFile for details."

'@

    $edgeRemovalPath = Join-Path $scriptsDir "EdgeRemoval.ps1"
    try {
        $edgeRemovalContent | Out-File -FilePath $edgeRemovalPath -Encoding UTF8 -Force
        Write-Log "Created: EdgeRemoval.ps1" "SUCCESS"
    } catch {
        Write-Log "Failed to create EdgeRemoval.ps1: $($_.Exception.Message)" "ERROR"
    }

    # Create OneDriveRemoval.ps1 script
    $oneDriveRemovalContent = @'

<#
  .SYNOPSIS
      Removes Microsoft OneDrive from Windows 10/11 systems.

  .DESCRIPTION
      This script detects and removes Microsoft OneDrive installations including:
      - Registry-based uninstallation using the user's HKU uninstall entry
      - OneDrive files and folders from the current users' AppData folder. (NOTE: Userdata in %USERPROFILE%\OneDrive is preserved)
      - System-wide OneDrive installation files
      - OneDrive scheduled tasks
      - Start Menu shortcuts
      - Default user profile configuration to prevent auto-installation

      This script is designed to run in any context: user sessions, SYSTEM account, or scheduled tasks.

  .NOTES
      Source: https://github.com/memstechtips/Winhance

      Requirements:
      - Windows 10/11
      - Administrator privileges (script will auto-elevate)
      - PowerShell 5.1 or higher
#>

# Check if script is running as Administrator
If (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]"Administrator")) {
    Try {
        Start-Process PowerShell.exe -ArgumentList ("-NoProfile -ExecutionPolicy Bypass -File `"{0}`"" -f $PSCommandPath) -Verb RunAs
        Exit
    }
    Catch {
        Write-Host "Failed to run as Administrator. Please rerun with elevated privileges."
        Exit
    }
}

# Setup logging
$logFolder = "C:\ProgramData\Winhance\Logs"
$logFile = "$logFolder\OneDriveRemovalLog.txt"

# Create log directory if it doesn't exist
if (!(Test-Path $logFolder)) {
    New-Item -ItemType Directory -Path $logFolder -Force | Out-Null
}

# Function to write to log file
function Write-Log {
    param (
        [string]$Message
    )

    # Check if log file exists and is over 500KB (512000 bytes)
    if ((Test-Path $logFile) -and (Get-Item $logFile).Length -gt 512000) {
        Remove-Item $logFile -Force -ErrorAction SilentlyContinue
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        "$timestamp - Log rotated - previous log exceeded 500KB" | Out-File -FilePath $logFile

        # Also output to console for real-time progress
        Write-Host $Message
    }

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$timestamp - $Message" | Out-File -FilePath $logFile -Append
}

Write-Host "Starting OneDrive removal process. See $logFile for details."
Write-Log "Starting OneDrive removal process"

# Get the interactive user when running as SYSTEM (not needed for regular user execution)
function Get-TargetUser {
    Write-Log "Get-TargetUser: Starting user detection"

    # Try interactive user first
    try {
        $user = Get-WmiObject Win32_ComputerSystem | Select-Object -ExpandProperty UserName
        Write-Log "Get-TargetUser: Win32_ComputerSystem returned: '$user'"
        if ($user -and $user -ne "NT AUTHORITY\SYSTEM") {
            $username = $user.Split('\')[1]
            Write-Log "Get-TargetUser: Extracted username: '$username'"
            return $username
        }
        Write-Log "Get-TargetUser: User is null or SYSTEM, trying fallback method"
    }
    catch {
        Write-Log "Get-TargetUser: Win32_ComputerSystem failed: $($_.Exception.Message)"
    }

    # Fallback: find user running explorer.exe
    try {
        $explorer = Get-Process explorer -ErrorAction SilentlyContinue | Select-Object -First 1
        Write-Log "Get-TargetUser: Explorer process found: $($explorer -ne $null)"
        if ($explorer) {
            $owner = $explorer.GetOwner()
            Write-Log "Get-TargetUser: Explorer owner: Domain='$($owner.Domain)', User='$($owner.User)'"
            return $owner.User
        }
        Write-Log "Get-TargetUser: No explorer process found"
    }
    catch {
        Write-Log "Get-TargetUser: Explorer method failed: $($_.Exception.Message)"
    }

    Write-Log "Get-TargetUser: No user found, returning null"
    return $null
}

# Get the user's SID for registry access
function Get-UserSID {
    param($Username)
    try {
        $user = New-Object System.Security.Principal.NTAccount($Username)
        return $user.Translate([System.Security.Principal.SecurityIdentifier]).Value
    }
    catch {
        Write-Log "Get-UserSID: Failed for user '$Username': $($_.Exception.Message)"
        return $null
    }
}

# Determine user profile to check
Write-Log "Current environment: USERNAME='$env:USERNAME', USERPROFILE='$env:USERPROFILE'"

if ($env:USERNAME -eq "SYSTEM" -or $env:USERNAME -like "*$" -or $env:USERPROFILE -like "*\system32\config\systemprofile") {
    Write-Log "Running as SYSTEM, attempting to detect target user"
    $targetUser = Get-TargetUser
    if ($targetUser) {
        $userProfilePath = "C:\Users\$targetUser"
        Write-Log "Running as SYSTEM, targeting user: '$targetUser', profile path: '$userProfilePath'"
    } else {
        Write-Log "Running as SYSTEM but no target user found"
        $userProfilePath = $null
    }
} else {
    $targetUser = $env:USERNAME
    $userProfilePath = $env:USERPROFILE
    Write-Log "Running as regular user: '$targetUser', profile path: '$userProfilePath'"
}

# Step 1: Check registry for OneDrive installation and run uninstaller if found
if ($targetUser) {
    $userSID = Get-UserSID -Username $targetUser
    if ($userSID) {
        Write-Log "User SID for '$targetUser': $userSID"

        # Check if OneDrive uninstall entry exists in user's registry
        $uninstallKey = "HKU\$userSID\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\OneDriveSetup.exe"
        Write-Log "Checking uninstall registry key: $uninstallKey"

        try {
            # Query the uninstall string
            $uninstallString = reg.exe query $uninstallKey /v UninstallString 2>$null
            if ($LASTEXITCODE -eq 0 -and $uninstallString) {
                # Extract the actual command from reg output
                $uninstallLine = $uninstallString | Where-Object { $_ -match "UninstallString" } | Select-Object -First 1
                if ($uninstallLine -match "REG_SZ\s+(.+)") {
                    $uninstallCommand = $matches[1].Trim()
                    Write-Log "Found uninstall command: $uninstallCommand"

                    # Stop OneDrive processes
                    Write-Log "Stopping OneDrive processes"
                    Stop-Process -Name "*OneDrive*" -Force -ErrorAction SilentlyContinue | Out-Null

                    # Execute the uninstall command directly
                    Write-Log "Executing registry-based uninstaller"

                    if ($uninstallCommand -match '^"([^"]+)"(.*)') {
                        $exePath = $matches[1]
                        $arguments = $matches[2].Trim()
                        Write-Log "Command: '$exePath' Arguments: '$arguments'"
                        Start-Process -FilePath $exePath -ArgumentList $arguments -WindowStyle Hidden -Wait | Out-Null
                    } else {
                        # Fallback: execute as-is
                        Write-Log "Command: '$uninstallCommand'"
                        cmd.exe /c $uninstallCommand 2>&1 | Out-Null
                    }
                    Write-Log "Registry-based uninstaller completed"
                } else {
                    Write-Log "Could not parse UninstallString from registry output"
                }
            } else {
                Write-Log "OneDrive uninstall registry key not found or empty"
            }
        }
        catch {
            Write-Log "Registry-based uninstall failed: $($_.Exception.Message)"
        }
    } else {
        Write-Log "Could not get user SID for '$targetUser'"
    }
} else {
    Write-Log "No target user found for uninstall check"
}

# Step 3: Always run cleanup tasks
Write-Log "Starting cleanup tasks"

# 3.1: Delete OneDrive registry key
if ($targetUser -and $userSID) {
    $uninstallKey = "HKU\$userSID\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\OneDriveSetup.exe"
    Write-Log "Deleting OneDrive uninstall registry key: $uninstallKey"
    reg.exe delete $uninstallKey /f 2>&1 | Out-Null
    if ($LASTEXITCODE -eq 0) {
        Write-Log "Registry key deleted successfully"
    } else {
        Write-Log "Registry key not found or already deleted"
    }
}

# 3.2: Delete OneDrive AppData folder
if ($userProfilePath) {
    $currentUserOneDrivePath = Join-Path $userProfilePath "AppData\Local\Microsoft\OneDrive"
    Write-Log "Checking OneDrive AppData folder: $currentUserOneDrivePath"

    if (Test-Path $currentUserOneDrivePath) {
        Write-Log "Removing OneDrive folder for user: $targetUser"
        try {
            takeown /f $currentUserOneDrivePath /r /d y 2>&1 | Out-Null
            icacls $currentUserOneDrivePath /grant "${env:USERNAME}:F" /t 2>&1 | Out-Null
            Remove-Item $currentUserOneDrivePath -Recurse -Force -ErrorAction SilentlyContinue
            Write-Log "OneDrive folder removed for user: $targetUser"
        }
        catch {
            Write-Log "Failed to remove OneDrive folder for user: $targetUser - $($_.Exception.Message)"
        }
    } else {
        Write-Log "OneDrive AppData folder not found"
    }
}

# 3.3: Delete OneDrive Start Menu entry
if ($userProfilePath) {
    $startMenuPath = Join-Path $userProfilePath "AppData\Roaming\Microsoft\Windows\Start Menu\Programs\OneDrive.lnk"
    Write-Log "Checking OneDrive Start Menu shortcut: $startMenuPath"

    if (Test-Path $startMenuPath) {
        Remove-Item $startMenuPath -Force -ErrorAction SilentlyContinue
        Write-Log "OneDrive Start Menu shortcut removed"
    } else {
        Write-Log "OneDrive Start Menu shortcut not found"
    }
}

# 3.4: Delete system OneDrive files
$systemPaths = @(
    "C:\Windows\System32\OneDriveSetup.exe",
    "C:\Windows\SysWOW64\OneDriveSetup.exe",
    "C:\Program Files\Microsoft OneDrive"
)

foreach ($path in $systemPaths) {
    Write-Log "Checking system path: $path"
    if (Test-Path $path) {
        Write-Log "Removing: $path"
        try {
            takeown /f $path /r /d y 2>&1 | Out-Null
            icacls $path /grant "${env:USERNAME}:F" /t 2>&1 | Out-Null
            Remove-Item $path -Recurse -Force -ErrorAction SilentlyContinue
            Write-Log "Successfully removed: $path"
        }
        catch {
            Write-Log "Failed to remove: $path - $($_.Exception.Message)"
        }
    } else {
        Write-Log "Path not found: $path"
    }
}

# 3.5: Delete OneDrive scheduled tasks
Write-Log "Checking for OneDrive scheduled tasks"
try {
    $oneDriveTasks = Get-ScheduledTask -TaskName "*OneDrive*" -ErrorAction SilentlyContinue
    if ($oneDriveTasks) {
        foreach ($task in $oneDriveTasks) {
            # Skip the OneDriveRemoval task
            if ($task.TaskName -eq "OneDriveRemoval") {
                Write-Log "Skipping OneDriveRemoval task: $($task.TaskName)"
                continue
            }
            
            Write-Log "Found OneDrive scheduled task: $($task.TaskName) - State: $($task.State)"
            try {
                Unregister-ScheduledTask -TaskName $task.TaskName -TaskPath $task.TaskPath -Confirm:$false -ErrorAction SilentlyContinue
                Write-Log "Deleted scheduled task: $($task.TaskName)"
            }
            catch {
                Write-Log "Failed to delete scheduled task: $($task.TaskName) - $($_.Exception.Message)"
            }
        }
    } else {
        Write-Log "No OneDrive scheduled tasks found"
    }
}
catch {
    Write-Log "Failed to check scheduled tasks: $($_.Exception.Message)"
}

# 3.6: Configure default user registry to prevent OneDrive auto-install
$markerKey = "HKLM\SOFTWARE\Winhance\OneDriveRemoval"
$markerValue = reg.exe query $markerKey /v "DefaultUserConfigured" 2>$null

if ($LASTEXITCODE -eq 0) {
    Write-Log "Default user already configured on this machine, skipping this step."
} else {
    Write-Log "Configuring registry to prevent OneDrive auto-install for new users"
    reg.exe Load HKEY_USERS\Default "C:\Users\Default\NTUSER.DAT" 2>&1 | Out-Null
    reg.exe delete "HKU\Default\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "OneDriveSetup" /f 2>&1 | Out-Null
    reg.exe add "HKU\Default\SOFTWARE\Microsoft\OneDrive" /v "EnableTHDFFeatures" /t REG_DWORD /d "0" /f 2>&1 | Out-Null
    # Close regedit in case it is running so we can unload the hive
    Stop-Process -Name "regedit" -Force -ErrorAction SilentlyContinue
    reg.exe Unload HKEY_USERS\Default 2>&1 | Out-Null

    # Create marker to indicate this machine has been configured
    reg.exe add $markerKey /v "DefaultUserConfigured" /t REG_SZ /d "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" /f 2>&1 | Out-Null
    Write-Log "Default user configuration completed and marked"
}

Write-Log "Done."
Write-Host "Done. See $logFile for details."

'@

    $oneDriveRemovalPath = Join-Path $scriptsDir "OneDriveRemoval.ps1"
    try {
        $oneDriveRemovalContent | Out-File -FilePath $oneDriveRemovalPath -Encoding UTF8 -Force
        Write-Log "Created: OneDriveRemoval.ps1" "SUCCESS"
    } catch {
        Write-Log "Failed to create OneDriveRemoval.ps1: $($_.Exception.Message)" "ERROR"
    }


    # Execute removal scripts and register scheduled tasks
    $scriptsToExecute = @()
    $scriptsToExecute += @{Path = "$scriptsDir\BloatRemoval.ps1"; Name = "BloatRemoval"; TriggerType = "Logon"}
    $scriptsToExecute += @{Path = "$scriptsDir\EdgeRemoval.ps1"; Name = "EdgeRemoval"; TriggerType = "Startup"}
    $scriptsToExecute += @{Path = "$scriptsDir\OneDriveRemoval.ps1"; Name = "OneDriveRemoval"; TriggerType = "Logon"}

    foreach ($script in $scriptsToExecute) {
        if (Test-Path $script.Path) {
            Write-Log "Executing $($script.Name) script..." "INFO"
            try {
                Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -NoProfile -File `"$($script.Path)`"" -Wait -NoNewWindow
                Write-Log "$($script.Name) execution completed" "SUCCESS"
            } catch {
                Write-Log "$($script.Name) execution failed: $($_.Exception.Message)" "WARNING"
            }

            # Register scheduled task
            Write-Log "Registering scheduled task for $($script.Name)..." "INFO"
            try {
                $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -NoProfile -File `"$($script.Path)`""

                if ($script.TriggerType -eq "Startup") {
                    $trigger = New-ScheduledTaskTrigger -AtStartup
                } else {
                    $trigger = New-ScheduledTaskTrigger -AtLogon
                }

                $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit 0
                $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest

                Register-ScheduledTask -TaskName $script.Name -TaskPath "\Winhance" -Action $action -Trigger $trigger -Settings $settings -Principal $principal -Force | Out-Null
                Write-Log "Registered scheduled task: $($script.Name)" "SUCCESS"
            } catch {
                Write-Log "Failed to register task $($script.Name): $($_.Exception.Message)" "ERROR"
            }
        }
    }

    Write-Log "Windows Apps removal configuration completed" "SUCCESS"
    # Create WinhanceInstall.ps1 script
    $winhanceInstallContent = @'

function Get-FileFromWeb {
    param ([Parameter(Mandatory)][string]$URL, [Parameter(Mandatory)][string]$File)
    function Show-Progress {
        param ([Parameter(Mandatory)][Single]$TotalValue, [Parameter(Mandatory)][Single]$CurrentValue, [Parameter(Mandatory)][string]$ProgressText, [Parameter()][int]$BarSize = 10, [Parameter()][switch]$Complete)
        $percent = $CurrentValue / $TotalValue
        $percentComplete = $percent * 100
        if ($psISE) { Write-Progress "$ProgressText" -id 0 -percentComplete $percentComplete }
        else { Write-Host -NoNewLine "`r$ProgressText $(''.PadRight($BarSize * $percent, [char]9608).PadRight($BarSize, [char]9617)) $($percentComplete.ToString('##0.00').PadLeft(6)) % " }
    }
    try {
        $request = [System.Net.HttpWebRequest]::Create($URL)
        $response = $request.GetResponse()
        if ($response.StatusCode -eq 401 -or $response.StatusCode -eq 403 -or $response.StatusCode -eq 404) { throw "Remote file either doesn't exist, is unauthorized, or is forbidden for '$URL'." }
        if ($File -match '^\.\\') { $File = Join-Path (Get-Location -PSProvider 'FileSystem') ($File -Split '^\.')[1] }
        if ($File -and !(Split-Path $File)) { $File = Join-Path (Get-Location -PSProvider 'FileSystem') $File }
        if ($File) { $fileDirectory = $([System.IO.Path]::GetDirectoryName($File)); if (!(Test-Path($fileDirectory))) { [System.IO.Directory]::CreateDirectory($fileDirectory) | Out-Null } }
        [long]$fullSize = $response.ContentLength
        [byte[]]$buffer = new-object byte[] 1048576
        [long]$total = [long]$count = 0
        $reader = $response.GetResponseStream()
        $writer = new-object System.IO.FileStream $File, 'Create'
        do {
            $count = $reader.Read($buffer, 0, $buffer.Length)
            $writer.Write($buffer, 0, $count)
            $total += $count
            if ($fullSize -gt 0) { Show-Progress -TotalValue $fullSize -CurrentValue $total -ProgressText " Downloading Winhance Installer" }
        } while ($count -gt 0)
    }
    finally {
        $reader.Close()
        $writer.Close()
    }
}

$installerPath = "C:\ProgramData\Winhance\Unattend\WinhanceInstaller.exe"
$downloadUrl = "https://github.com/memstechtips/Winhance/releases/latest/download/Winhance.Installer.exe"

try {
    Write-Host "Downloading Winhance Installer from GitHub..." -ForegroundColor Cyan
    Get-FileFromWeb -URL $downloadUrl -File $installerPath
    Write-Host ""
    Write-Host "Download completed successfully!" -ForegroundColor Green
    Write-Host "Launching Winhance Installer..." -ForegroundColor Cyan
    Start-Process -FilePath $installerPath
    Write-Host "Installer launched." -ForegroundColor Green
} catch {
    Write-Host ""
    Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host ""
    Write-Host "Press any key to exit..." -ForegroundColor Yellow
    $null = $Host.UI.RawUI.ReadKey('NoEcho,IncludeKeyDown')
}

'@

    $winhanceInstallPath = Join-Path $scriptsDir "WinhanceInstall.ps1"
    try {
        $winhanceInstallContent | Out-File -FilePath $winhanceInstallPath -Encoding UTF8 -Force
        Write-Log "Created: WinhanceInstall.ps1" "SUCCESS"
    } catch {
        Write-Log "Failed to create WinhanceInstall.ps1: $($_.Exception.Message)" "ERROR"
    }

    # Create desktop shortcut for Winhance installer
    try {
        $targetFile = Join-Path $scriptsDir "WinhanceInstall.ps1"
        $shortcutPath = "C:\Users\Default\Desktop\Install Winhance.lnk"
        $WshShell = New-Object -ComObject WScript.Shell
        $shortcut = $WshShell.CreateShortcut($shortcutPath)
        $shortcut.TargetPath = "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"
        $shortcut.Arguments = "-ExecutionPolicy Bypass -NoProfile -File `"$targetFile`""
        $shortcut.IconLocation = "C:\Windows\System32\appwiz.cpl,0"
        $shortcut.WorkingDirectory = "C:\Windows\System32"
        $shortcut.Description = "Launch Winhance Installer with Administrator Privileges"
        $shortcut.Save()
        $bytes = [System.IO.File]::ReadAllBytes($shortcutPath)
        $bytes[21] = 34
        [System.IO.File]::WriteAllBytes($shortcutPath, $bytes)
        Write-Log "Created desktop shortcut: $shortcutPath" "SUCCESS"
    } catch {
        Write-Log "Failed to create desktop shortcut: $($_.Exception.Message)" "ERROR"
    }


    # ============================================================================
    # POWER PLAN & POWERCFG SETTINGS
    # ============================================================================

    Write-Log "Setting up power plan: Winhance Power Plan..." "INFO"

    $customPlanGuid = "20ac8c6a-267d-4408-b47e-4ea0c0e3302f"

    $existingPlan = powercfg /query $customPlanGuid 2>&1
    $planExists = $LASTEXITCODE -eq 0

    if ($planExists) {
        Write-Log "Power plan already exists, using existing plan" "INFO"
    } else {
        Write-Log "Creating new power plan..." "INFO"
        $planCreated = $false

        $sourceSchemes = @(
            @{ Name = "Ultimate Performance"; Guid = "e9a42b02-d5df-448d-aa00-03f14749eb61" },
            @{ Name = "High Performance"; Guid = "8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c" },
            @{ Name = "Balanced"; Guid = "381b4222-f694-41f0-9685-ff5bb260df2e" }
        )

        foreach ($scheme in $sourceSchemes) {
            Write-Log "Attempting to duplicate from $($scheme.Name)..." "INFO"
            $result = powercfg /duplicatescheme $($scheme.Guid) $customPlanGuid 2>&1
            if ($LASTEXITCODE -eq 0) {
                Write-Log "Successfully created from $($scheme.Name)" "SUCCESS"
                powercfg /changename $customPlanGuid "Winhance Power Plan" | Out-Null
                $planCreated = $true
                break
            }
        }

        if (-not $planCreated) {
            Write-Log "Failed to create power plan" "ERROR"
        }
    }

    Write-Log "Disabling hibernation..." "INFO"
    powercfg /hibernate off 2>$null
    Write-Log "Hibernation disabled" "SUCCESS"

    Write-Log "Enabling hidden power settings..." "INFO"
    $PowerSettingsBasePath = "HKLM:\SYSTEM\CurrentControlSet\Control\Power\PowerSettings"
    $hiddenSettings = @(
        @{ Subgroup = "2a737441-1930-4402-8d77-b2bebba308a3"; Setting = "0853a681-27c8-4100-a2fd-82013e970683" },
        @{ Subgroup = "2a737441-1930-4402-8d77-b2bebba308a3"; Setting = "d4e98f31-5ffe-4ce1-be31-1b38b384c009" },
        @{ Subgroup = "4f971e89-eebd-4455-a8de-9e59040e7347"; Setting = "7648efa3-dd9c-4e3e-b566-50f929386280" },
        @{ Subgroup = "4f971e89-eebd-4455-a8de-9e59040e7347"; Setting = "96996bc0-ad50-47ec-923b-6f41874dd9eb" },
        @{ Subgroup = "4f971e89-eebd-4455-a8de-9e59040e7347"; Setting = "5ca83367-6e45-459f-a27b-476b1d01c936" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "94d3a615-a899-4ac5-ae2b-e4d8f634367f" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "be337238-0d82-4146-a960-4f3749d470c7" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "465e1f50-b610-473a-ab58-00d1077dc418" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "40fbefc7-2e9d-4d25-a185-0cfd8574bac6" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "0cc5b647-c1df-4637-891a-dec35c318583" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "ea062031-0e34-4ff1-9b6d-eb1059334028" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "36687f9e-e3a5-4dbf-b1dc-15eb381c6863" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "06cadf0e-64ed-448a-8927-ce7bf90eb35d" },
        @{ Subgroup = "54533251-82be-4824-96c1-47b60b740d00"; Setting = "12a0ab44-fe28-4fa9-b3bd-4b64f44960a6" }
    )

    $enabledCount = 0
    foreach ($item in $hiddenSettings) {
        $regPath = Join-Path $PowerSettingsBasePath "$($item.Subgroup)\$($item.Setting)"
        try {
            if (Test-Path $regPath) {
                Set-ItemProperty -Path $regPath -Name "Attributes" -Value 0 -Type DWord -ErrorAction Stop
                $enabledCount++
            }
        } catch {
        }
    }
    Write-Log "Enabled $enabledCount hidden power settings" "SUCCESS"

    Write-Log "Applying power settings..." "INFO"

    $settings = @(
        @{ S="7516b95f-f776-4464-8c53-06167f40cc99"; G="3c0bc021-c8a8-4e07-a973-6b14cbcb2b7e"; AC=0; DC=300; N="Specifies the period of inactivity before Windows turns off the display" },
        @{ S="0012ee47-9041-4b5d-9b77-535fba8b1442"; G="6738e2c4-e8a5-4a42-b16a-e040e769756e"; AC=0; DC=600; N="Specifies the period of inactivity before Windows turns off the hard disk" },
        @{ S="0d7dbae2-4294-402a-ba8e-26777e8488cd"; G="309dce9b-bef4-4119-9921-a851fb12f0f4"; AC=0; DC=1; N="Allow or prevent Windows from rotating through multiple wallpaper images" },
        @{ S="19cbb8fa-5279-450e-9fac-8a3d5fedd0c1"; G="12bbebe6-58d6-4636-95bb-3217ef867c1a"; AC=0; DC=2; N="Balance wireless network performance with battery life by adjusting adapter power usage" },
        @{ S="238c9fa8-0aad-41ed-83f4-97be242c8f20"; G="29f6c1db-86da-48c5-9fdb-f2b67b1f44da"; AC=0; DC=900; N="Specifies the period of inactivity before Windows puts the computer to sleep" },
        @{ S="238c9fa8-0aad-41ed-83f4-97be242c8f20"; G="bd3b718a-0680-4d9d-8ab2-e1d2b4ac806d"; AC=0; DC=0; N="Allow scheduled tasks and applications to wake your computer from sleep" },
        @{ S="238c9fa8-0aad-41ed-83f4-97be242c8f20"; G="9d7815a6-7ee4-497e-8888-515a05f02364"; AC=0; DC=0; N="Specifies the period of inactivity before Windows hibernates the computer" },
        @{ S="238c9fa8-0aad-41ed-83f4-97be242c8f20"; G="94ac6d29-73ce-41a6-809f-6363ba21b47e"; AC=0; DC=1; N="Combines sleep and hibernate by saving your session to disk while staying in low-power mode for faster wake" },
        @{ S="2a737441-1930-4402-8d77-b2bebba308a3"; G="0853a681-27c8-4100-a2fd-82013e970683"; AC=0; DC=1000; N="Set how long USB hubs wait idle before powering down to save energy" },
        @{ S="2a737441-1930-4402-8d77-b2bebba308a3"; G="48e6b7a6-50f5-4782-a5d4-53bb8f07e226"; AC=0; DC=1; N="Allow Windows to power down individual USB ports when devices are idle to save energy" },
        @{ S="2a737441-1930-4402-8d77-b2bebba308a3"; G="d4e98f31-5ffe-4ce1-be31-1b38b384c009"; AC=0; DC=2; N="Control how aggressively USB 3.0 ports enter low-power states when devices are idle" },
        @{ S="4f971e89-eebd-4455-a8de-9e59040e7347"; G="7648efa3-dd9c-4e3e-b566-50f929386280"; AC=0; DC=0; N="Choose what happens when you press the physical power button on your computer" },
        @{ S="4f971e89-eebd-4455-a8de-9e59040e7347"; G="96996bc0-ad50-47ec-923b-6f41874dd9eb"; AC=0; DC=0; N="Choose what happens when you press the dedicated sleep button on your keyboard or computer" },
        @{ S="501a4d13-42af-4429-9fd1-a8218c268e20"; G="ee12f906-d277-404b-b6da-e5fa1a576df5"; AC=0; DC=2; N="Control power savings for PCIe devices like graphics cards, SSDs, and expansion cards" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="893dee8e-2bef-41e0-89c6-b55d0929964c"; AC=100; DC=5; N="Set the lowest CPU speed allowed as a percentage of maximum frequency" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="bc5038f7-23e0-4960-96da-33abaf5935ec"; AC=100; DC=100; N="Set the highest CPU speed allowed as a percentage of maximum frequency" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="94d3a615-a899-4ac5-ae2b-e4d8f634367f"; AC=1; DC=1; N="Choose whether to slow down the processor first (passive) or speed up fans first (active) when hot" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="be337238-0d82-4146-a960-4f3749d470c7"; AC=2; DC=1; N="Control how aggressively your CPU boosts above base frequency for demanding tasks" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="465e1f50-b610-473a-ab58-00d1077dc418"; AC=2; DC=0; N="Control how quickly CPU ramps up speed when workload increases (for legacy non-HWP processors)" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="40fbefc7-2e9d-4d25-a185-0cfd8574bac6"; AC=1; DC=2; N="Control how quickly CPU reduces speed when workload decreases (for legacy non-HWP processors)" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="0cc5b647-c1df-4637-891a-dec35c318583"; AC=0; DC=0; N="Set the minimum percentage of CPU cores that must remain active and responsive" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="ea062031-0e34-4ff1-9b6d-eb1059334028"; AC=100; DC=100; N="Set the maximum percentage of CPU cores allowed to be active (100% for best performance)" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="36687f9e-e3a5-4dbf-b1dc-15eb381c6863"; AC=0; DC=50; N="Balance power efficiency and performance for modern CPUs with HWP (0 = max performance, 100 = max efficiency)" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="06cadf0e-64ed-448a-8927-ce7bf90eb35d"; AC=10; DC=30; N="Set CPU usage percentage that triggers speed increase (lower = more responsive, for legacy non-HWP CPUs)" },
        @{ S="54533251-82be-4824-96c1-47b60b740d00"; G="12a0ab44-fe28-4fa9-b3bd-4b64f44960a6"; AC=8; DC=20; N="Set CPU usage percentage that triggers speed reduction (lower = maintains performance longer, for legacy non-HWP CPUs)" },
        @{ S="9596fb26-9850-41fd-ac3e-f7c3c00afd4b"; G="03680956-93bc-4294-bba6-4e0f09bb717f"; AC=1; DC=1; N="Control whether your PC can sleep while streaming media to other devices on your network" },
        @{ S="9596fb26-9850-41fd-ac3e-f7c3c00afd4b"; G="10778347-1370-4ee0-8bbd-33bdacaade49"; AC=1; DC=1; N="Prioritize smooth video playback over battery life when watching videos" },
        @{ S="9596fb26-9850-41fd-ac3e-f7c3c00afd4b"; G="34c7b99f-9a6d-4b3c-8dc7-b6693b78cef4"; AC=0; DC=0; N="Balance video quality and power consumption during video playback" },
        @{ S="c763b4ec-0e50-4b6b-9bed-2b92a6ee884e"; G="7ec1751b-60ed-4588-afb5-9819d3d77d90"; AC=3; DC=1; N="Balance AMD laptop performance and battery life with quick power mode selection" }
    )

    $appliedCount = 0
    $targetPlanGuid = "20ac8c6a-267d-4408-b47e-4ea0c0e3302f"
    foreach ($setting in $settings) {
        try {
            powercfg /setacvalueindex $targetPlanGuid $setting.S $setting.G $setting.AC 2>$null
            if ($LASTEXITCODE -eq 0) {
                powercfg /setdcvalueindex $targetPlanGuid $setting.S $setting.G $setting.DC 2>$null
                if ($LASTEXITCODE -eq 0) {
                    $appliedCount++
                }
            }
        } catch {
        }
    }
    Write-Log "Applied $appliedCount power settings" "SUCCESS"

    Write-Log "Activating power plan..." "INFO"
    powercfg /setactive 20ac8c6a-267d-4408-b47e-4ea0c0e3302f 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Log "Power plan activated successfully" "SUCCESS"
    } else {
        Write-Log "Failed to activate power plan" "WARNING"
    }


    # ============================================================================
    # GAMING & PERFORMANCE SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\AppPrivacy' -Name 'LetAppsRunInBackground' -Type 'DWord' -Value 0 -Description 'Allow apps to receive notifications, update data, and perform tasks even when not actively in use'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\StorageSense' -Name 'AllowStorageSenseGlobal' -Type 'DWord' -Value 0 -Description 'Automatically free up disk space by removing temporary files, emptying the recycle bin, and managing downloads'
    Set-RegistryValue -Path 'HKLM:\System\CurrentControlSet\Control\PriorityControl' -Name 'Win32PrioritySeparation' -Type 'DWord' -Value 38 -Description 'Configure how Windows allocates CPU time between foreground applications and background services'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile' -Name 'SystemResponsiveness' -Type 'DWord' -Value 10 -Description 'Minimize background task interference by allocating more CPU time to your active game or multimedia application'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games' -Name 'Priority' -Type 'DWord' -Value 6 -Description 'Give games higher CPU scheduling priority to dedicate more processor time to your game'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games' -Name 'Scheduling Category' -Type 'String' -Value 'High' -Description 'Assign high-priority scheduling category to ensure games receive preferential system resource allocation'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games' -Name 'GPU Priority' -Type 'DWord' -Value 8 -Description 'Give games higher GPU scheduling priority to improve graphics performance and frame rates'
    Set-RegistryValue -Path 'HKLM:\System\CurrentControlSet\Control\GraphicsDrivers' -Name 'HwSchMode' -Type 'DWord' -Value 2 -Description 'Let your GPU manage its own memory and scheduling for reduced latency and improved performance'
    Set-RegistryValue -Path 'HKLM:\Software\NVIDIA Corporation\Global\FTS' -Name 'EnableGR535' -Type 'DWord' -Value 0 -Description 'Enable legacy NVIDIA image sharpening filter for enhanced visual clarity. Only works on older NVIDIA drivers; newer drivers should use NVIDIA Control Panel sharpening instead'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile' -Name 'NetworkThrottlingIndex' -Type 'DWord' -Value 10 -Description 'Disable network packet throttling to reduce latency and improve online gaming responsiveness'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' -Name 'TcpAckFrequency' -Type 'DWord' -Value 2 -Description 'Batch small network packets together before sending to improve efficiency. Disabling reduces latency for real-time online gaming but may slightly increase bandwidth usage'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' -Name 'TCPNoDelay' -Type 'DWord' -Value 0 -Description 'Batch small network packets together before sending to improve efficiency. Disabling reduces latency for real-time online gaming but may slightly increase bandwidth usage'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\GameConfigStore' -Name 'AllowGameDVR' -Type 'DWord' -Value 0 -Description 'Record gameplay clips and take screenshots using the Xbox Game Bar overlay. Disabling reduces CPU/GPU usage and can improve frame rates'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Control' -Name 'ServicesPipeTimeout' -Type 'DWord' -Value 30000 -Description 'Reduce the startup timeout for Windows services from 60 to 30 seconds. This can speed up boot time slightly'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SysMain' -Name 'Start' -Type 'DWord' -Value 4 -Description 'Preload frequently used applications into RAM for faster launch times. Automatic is recommended for HDDs, Manual or Disabled is preferred for SSDs'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters' -Name 'EnablePrefetcher' -Type 'DWord' -Value 0 -Description 'Preload frequently used applications and boot files into memory to speed up launches. Generally recommended for HDDs not SSDs'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WSearch' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Indexes files and folders for faster search results. Disabling reduces background CPU and disk activity but makes Windows Search slower'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Spooler' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Manages print jobs sent to printers. If you don''t use a printer, set to Manual or Disabled to free up system resources'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\DiagTrack' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Sends usage data and diagnostics to Microsoft. Setting to Manual or Disabled reduces background network and CPU usage'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\PcaSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Monitors programs for compatibility issues and suggests fixes. Disabling prevents compatibility prompts and saves minor system resources'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WerSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Collects and sends crash data to Microsoft. Disabling prevents crash reporting, reduces network traffic, and improves privacy with minimal system impact'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\lfsvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Tracks your physical location for apps and services. Disabling improves privacy and prevents location tracking, but apps won''t be able to use location features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\RetailDemo' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Controls device activity when in retail demo mode. Safe to disable for personal computers as it only serves retail display purposes'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\wisvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Manages Windows Insider Program features and preview builds. Safe to disable if you''re not participating in the Windows Insider Program'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\PhoneSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Manages telephony state on the device. Safe to disable if you don''t use phone connectivity features or make calls from your PC'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WalletService' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Provides wallet functionality for payment and NFC scenarios. Safe to disable if you don''t use Microsoft Wallet features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SCardSvr' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Enables smart card reader functionality for security authentication. Safe to disable if you don''t use physical smart cards or card readers'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\ScDeviceEnum' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Enables smart card reader functionality for security authentication. Safe to disable if you don''t use physical smart cards or card readers'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SCPolicySvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Enables smart card reader functionality for security authentication. Safe to disable if you don''t use physical smart cards or card readers'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\MapsBroker' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Provides access to downloaded maps for applications. Set to Manual to allow map access when needed while preventing unnecessary background activity'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Fax' -Name 'Start' -Type 'DWord' -Value 4 -Description 'Enables sending and receiving faxes. Safe to disable for most users as fax functionality is rarely used on modern systems'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WMPNetworkSvc' -Name 'Start' -Type 'DWord' -Value 4 -Description 'Shares Windows Media Player libraries to other networked players and media devices. Safe to disable if you don''t share media over your network'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\MixedRealityOpenXRSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Runs OpenXR applications on Windows Mixed Reality devices. Safe to disable if you don''t use VR or AR headsets'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\icssvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Provides ability to share internet connection with other devices. Set to Manual to keep functionality available while preventing unnecessary background activity'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SmsRouter' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Routes SMS messages according to rules. Safe to disable if you don''t use SMS features on your PC'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WpcMonSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Enables parental controls and family safety features. Safe to disable if you don''t use parental control features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SEMgrSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Manages payments and Near Field Communication secure elements. Safe to disable if you don''t use NFC payment features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\svsvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Verifies potential file system corruptions. Set to Manual to allow verification when needed while reducing background activity'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\RasMan' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Manages VPN and dial-up connections. Set to Manual to reduce background activity while keeping VPN functionality available when needed.'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\RasAuto' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Automatically connects to remote networks when programs reference remote resources. Safe to disable if you don''t use auto-connect VPN features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\TermService' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Allows users to connect interactively to a remote computer. Set to Manual to reduce background activity while keeping Remote Desktop available.'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SessionEnv' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Manages Remote Desktop Services and Remote Desktop related configurations. Set to Manual to reduce background activity while keeping Remote Desktop available'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\UmRdpService' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Allows local device redirection for Remote Desktop connections. Safe to disable if you don''t need to share local devices during Remote Desktop sessions'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\BITS' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Transfers Windows Updates and downloads in the background. Setting to Manual allows updates to work while preventing constant background activity during gaming'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\XblAuthManager' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Provides authentication and authorization services for Xbox Live. Safe to disable if you don''t use Xbox Game Pass, Microsoft Store games, or Xbox features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\XblGameSave' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Syncs game saves to Xbox Live cloud. Only needed for Xbox Game Pass and Microsoft Store games with cloud save features'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\XboxNetApiSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Supports Xbox Live multiplayer networking. Required for Xbox multiplayer gaming but not needed for Steam/Epic/other gaming platforms'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\WbioSrvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Enables fingerprint and facial recognition login via Windows Hello. Safe to disable on desktop systems without biometric hardware'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\TabletInputService' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Enables touch keyboard and pen input functionality. Safe to disable on desktop systems without touchscreen or stylus'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SensrSvc' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Monitors various sensors like ambient light and orientation. Safe to disable on desktop systems without sensor hardware'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\SensorDataService' -Name 'Start' -Type 'DWord' -Value 3 -Description 'Delivers data from a variety of sensors to applications. Safe to disable on desktop systems without sensor hardware'

    $scheduledTasks = @(
        @{ TN="\Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser"; Action="/Disable"; Desc="Collects program compatibility telemetry for Windows upgrades. Works alongside the Connected User Experiences and Telemetry Service. Disable to reduce telemetry and background system activity" },
        @{ TN="\Microsoft\Windows\Application Experience\ProgramDataUpdater"; Action="/Disable"; Desc="Updates the program compatibility database with information about installed applications. Disable to reduce telemetry collection" },
        @{ TN="\Microsoft\Windows\Customer Experience Improvement Program\Consolidator"; Action="/Disable"; Desc="Consolidates and uploads usage data as part of the Customer Experience Improvement Program. Works with the Connected User Experiences and Telemetry Service. Disable to improve privacy" },
        @{ TN="\Microsoft\Windows\Customer Experience Improvement Program\UsbCeip"; Action="/Disable"; Desc="Collects USB device-related telemetry for the Customer Experience Improvement Program. Disable to reduce telemetry" },
        @{ TN="\Microsoft\Windows\DiskDiagnostic\Microsoft-Windows-DiskDiagnosticDataCollector"; Action="/Disable"; Desc="Collects disk diagnostic information and S.M.A.R.T. data for Microsoft. Disable to reduce background disk activity and telemetry" },
        @{ TN="\Microsoft\Windows\Feedback\Siuf\DmClient"; Action="/Disable"; Desc="Collects feedback and diagnostic data for Microsoft. Disable to improve privacy and reduce telemetry" },
        @{ TN="\Microsoft\Windows\Feedback\Siuf\DmClientOnScenarioDownload"; Action="/Disable"; Desc="Downloads feedback scenarios and configuration data from Microsoft. Disable to reduce telemetry and network activity" },
        @{ TN="\Microsoft\Windows\Windows Error Reporting\QueueReporting"; Action="/Disable"; Desc="Queues crash reports and error data to send to Microsoft. Works alongside the Windows Error Reporting Service. Disable both to prevent crash data collection" },
        @{ TN="\Microsoft\Windows\PI\Sqm-Tasks"; Action="/Disable"; Desc="Collects software quality metrics and reliability data for Microsoft telemetry. Disable to improve privacy" },
        @{ TN="\Microsoft\Windows\Application Experience\MareBackup"; Action="/Disable"; Desc="Backs up Microsoft Assisted Recovery data. Disable to reduce background system activity" },
        @{ TN="\Microsoft\Windows\Application Experience\StartupAppTask"; Action="/Disable"; Desc="Tracks and monitors startup applications for telemetry and diagnostics. Disable to reduce telemetry" },
        @{ TN="\Microsoft\Windows\Application Experience\PcaPatchDbTask"; Action="/Disable"; Desc="Updates the Program Compatibility Assistant database. Works with the Program Compatibility Assistant Service. Disable both to prevent compatibility checking" },
        @{ TN="\Microsoft\Windows\Maps\MapsUpdateTask"; Action="/Disable"; Desc="Updates offline maps data for the Windows Maps app. Disable if you don''t use the Maps app to save bandwidth and storage" },
        @{ TN="\Microsoft\Windows\Autochk\Proxy"; Action="/Disable"; Desc="Performs disk checking operations and collects diagnostic data. Consider keeping enabled for disk health monitoring" },
        @{ TN="\Microsoft\Windows\Shell\FamilySafetyMonitor"; Action="/Disable"; Desc="Monitors family safety settings and usage. Disable if you don''t use family safety features" },
        @{ TN="\Microsoft\Windows\Power Efficiency Diagnostics\AnalyzeSystem"; Action="/Disable"; Desc="Analyzes system power consumption and collects energy efficiency data. Disable to reduce telemetry and background analysis" }
    )

    Write-Log "Applying scheduled task settings..." "INFO"
    $processedCount = 0
    foreach ($task in $scheduledTasks) {
        try {
            $result = & cmd.exe /c "schtasks /Change /TN `"$($task.TN)`" $($task.Action)" 2>&1
            if ($LASTEXITCODE -eq 0) {
                Write-Log "$($task.Desc)" "SUCCESS"
                $processedCount++
            } else {
                Write-Log "Task command failed for: $($task.Desc)" "WARNING"
            }
        } catch {
            Write-Log "Failed to process task: $($task.Desc) - $($_.Exception.Message)" "ERROR"
        }
    }
    Write-Log "Processed $processedCount scheduled task settings" "SUCCESS"


    # ============================================================================
    # NOTIFICATIONS SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows Defender Security Center\Notifications' -Name 'DisableNotifications' -Type 'DWord' -Value 0 -Description 'Show all notifications from Windows Security about threats, scans, and protection status'
    Set-RegistryValue -Path 'HKLM:\Software\Policies\Microsoft\Windows Defender Security Center\Notifications' -Name 'DisableNotifications' -Type 'DWord' -Value 0 -Description 'Show all notifications from Windows Security about threats, scans, and protection status'
    Set-RegistryValue -Path 'HKLM:\Software\Policies\Microsoft\Windows Defender Security Center\Notifications' -Name 'DisableEnhancedNotifications' -Type 'DWord' -Value 0 -Description 'Show all notifications from Windows Security about threats, scans, and protection status'

    # ============================================================================
    # POWER SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\SYSTEM\ControlSet001\Control\Session Manager\Power' -Name 'HiberbootEnabled' -Type 'DWord' -Value 0 -Description 'Hibernate system state during shutdown for faster boot times (does not affect restart)'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FlyoutMenuSettings' -Name 'ShowHibernateOption' -Type 'DWord' -Value 0 -Description 'Display the Hibernate option in the Start Menu power button menu'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Power\PowerThrottling' -Name 'PowerThrottlingOff' -Type 'DWord' -Value 1 -Description 'Automatically reduces CPU performance for background processes to improve battery life and reduce heat generation'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FlyoutMenuSettings' -Name 'ShowLockOption' -Type 'DWord' -Value 0 -Description 'Display the Lock option in the Start Menu power button menu'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FlyoutMenuSettings' -Name 'ShowSleepOption' -Type 'DWord' -Value 0 -Description 'Display the Sleep option in the Start Menu power button menu'

    # ============================================================================
    # PRIVACY & SECURITY SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name 'ConsentPromptBehaviorAdmin' -Type 'DWord' -Value 0 -Description 'Controls UAC notification level and secure desktop behavior'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name 'PromptOnSecureDesktop' -Type 'DWord' -Value 0 -Description 'Controls UAC notification level and secure desktop behavior'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WorkplaceJoin' -Name 'BlockAADWorkplaceJoin' -Type 'DWord' -Value 1 -Description 'Blocks the ''Allow my organization to manage my device'' and ''No, sign in to this app only'' pop-up messages'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\BitLocker' -Name 'PreventDeviceEncryption' -Type 'DWord' -Value 1 -Description 'Prevents Windows from automatically encrypting your device with BitLocker without user consent'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\PolicyManager\default\WiFi\AllowWiFiHotSpotReporting' -Name 'Value' -Type 'DWord' -Value 0 -Description 'Prevents sharing WiFi passwords with contacts and automatically connecting to suggested open hotspots'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\PolicyManager\default\WiFi\AllowAutoConnectToWiFiSenseHotspots' -Name 'Value' -Type 'DWord' -Value 0 -Description 'Prevents sharing WiFi passwords with contacts and automatically connecting to suggested open hotspots'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\Maintenance' -Name 'MaintenanceDisabled' -Type 'DWord' -Value 1 -Description 'Prevents Windows from running automatic system maintenance tasks during idle time'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting' -Name 'Disabled' -Type 'DWord' -Value 1 -Description 'Stops Windows from collecting and sending crash reports and error information to Microsoft'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Remote Assistance' -Name 'fAllowToGetHelp' -Type 'DWord' -Value 0 -Description 'Prevents others from connecting to your computer remotely to provide technical support. Disabling improves security by blocking external remote access'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name 'DisableLockWorkstation' -Type 'DWord' -Value 1 -Description 'Allows users to lock their computer using Windows+L, Start menu, or Ctrl+Alt+Del screen'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\AdvertisingInfo' -Name 'DisabledByGroupPolicy' -Type 'DWord' -Value 1 -Description 'Windows generates a unique advertising ID that apps use to track your activity and deliver personalized ads based on your behavior across different apps'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\InputPersonalization' -Name 'AllowInputPersonalization' -Type 'DWord' -Value 0 -Description 'Use your voice for apps using Microsoft''s online speech recognition technology'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'AllowTelemetry' -Type 'DWord' -Value 1 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'MaxTelemetryAllowed' -Type 'DWord' -Value 1 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection' -Name 'AllowTelemetry' -Type 'DWord' -Value 0 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
    Set-RegistryValue -Path 'HKLM:\Software\Policies\Microsoft\Windows\CloudContent' -Name 'DisableTailoredExperiencesWithDiagnosticData' -Type 'DWord' -Value 1 -Description 'Let Microsoft use your diagnostic data to show personalized tips, ads and recommendations'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection' -Name 'DoNotShowFeedbackNotifications' -Type 'DWord' -Value 1 -Description 'Let Windows ask you to provide feedback on experiences in Windows'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'PublishUserActivities' -Type 'DWord' -Value 0 -Description 'Allows you to jump back into what you were doing with apps, docs, or other activities on startup'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Search' -Name 'AllowCortana' -Type 'DWord' -Value 0 -Description 'Enables Microsoft''s Cortana virtual assistant for voice commands and searches'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\location' -Name 'Value' -Type 'String' -Value 'Deny' -Description 'Allows Windows and apps to access your device location for location-based features'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\LocationAndSensors' -Name 'DisableLocation' -Type 'DWord' -Value 1 -Description 'Allows Windows and apps to access your device location for location-based features'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\webcam' -Name 'Value' -Type 'String' -Value 'Allow' -Description 'Allow apps to have camera access'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\microphone' -Name 'Value' -Type 'String' -Value 'Allow' -Description 'Allow apps to have microphone access'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\userAccountInformation' -Name 'Value' -Type 'String' -Value 'Deny' -Description 'Allow apps to have account info access'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\appDiagnostics' -Name 'Value' -Type 'String' -Value 'Deny' -Description 'Allow apps to have app diagnostic access'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\OneDrive' -Name 'KFMBlockOptIn' -Type 'DWord' -Value 1 -Description 'Prevents OneDrive from automatically backing up important folders (Documents, Pictures, Desktop, etc.)'

    # ============================================================================
    # SOUND SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Authentication\LogonUI\BootAnimation' -Name 'DisableStartupSound' -Type 'DWord' -Value 1 -Description 'Play the Windows startup sound when your computer boots up'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\EditionOverrides' -Name 'UserSetting_DisableStartupSound' -Type 'DWord' -Value 1 -Description 'Play the Windows startup sound when your computer boots up'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\SpeechOneCore\Settings' -Name 'AgentActivationEnabled' -Type 'DWord' -Value 0 -Description 'Allow apps to listen and respond to voice commands like "Hey Cortana"'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\SpeechOneCore\Settings' -Name 'AgentActivationLastUsed' -Type 'DWord' -Value 0 -Description 'Remember and apply the most recently used voice activation configuration'

    # ============================================================================
    # WINDOWS UPDATE SETTINGS
    # ============================================================================

    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'NoAutoUpdate' -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'AUOptions' -Type 'DWord' -Value 2 -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'BranchReadinessLevel' -Type 'DWord' -Value 20 -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'DeferFeatureUpdates' -Type 'DWord' -Value 1 -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'DeferFeatureUpdatesPeriodInDays' -Type 'DWord' -Value 365 -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'DeferQualityUpdates' -Type 'DWord' -Value 1 -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'DeferQualityUpdatesPeriodInDays' -Type 'DWord' -Value 7 -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PauseFeatureUpdatesStartTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PauseFeatureUpdatesEndTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PauseQualityUpdatesStartTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PauseQualityUpdatesEndTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PauseUpdatesStartTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PauseUpdatesExpiryTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PausedQualityDate' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PausedFeatureDate' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'FlightSettingsMaxPauseDays' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'NoAUShutdownOption' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'AlwaysAutoRebootAtScheduledTime' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'AutoInstallMinorUpdates' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'UseWUServer' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PausedFeatureStatus' -Description 'Control how Windows updates are installed on your system'
    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'PausedQualityStatus' -Description 'Control how Windows updates are installed on your system'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeliveryOptimization' -Name 'DODownloadMode' -Type 'DWord' -Value 99 -Description 'Share downloaded updates with other PCs on your network or the internet to reduce bandwidth usage'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'IsContinuousInnovationOptedIn' -Type 'DWord' -Value 0 -Description 'Be among the first to get the latest non-security updates, fixes, and improvements as they roll out'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\WindowsUpdate\UX\Settings' -Name 'AllowMUUpdateService' -Type 'DWord' -Value 0 -Description 'Get Microsoft Office and other updates together with Windows updates'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\WindowsUpdate\UX\Settings' -Name 'IsExpedited' -Type 'DWord' -Value 0 -Description 'Restart as soon as possible (even during active hours) to finish updating'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'NoAutoRebootWithLoggedOnUsers' -Type 'DWord' -Value 1 -Description 'Prevents automatic restarts after installing updates when users are logged on'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name 'SetUpdateNotificationLevel' -Type 'DWord' -Value 1 -Description 'Show or hide notifications about available updates and update progress'
    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\WindowsUpdate\UX\Settings' -Name 'RestartNotificationsAllowed2' -Type 'DWord' -Value 0 -Description 'Show notification when your device requires a restart to finish updating'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings' -Name 'AllowAutoWindowsUpdateDownloadOverMeteredNetwork' -Type 'DWord' -Value 0 -Description 'Allow Windows to download updates when using mobile hotspots or data-limited connections'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name 'ExcludeWUDriversInQualityUpdate' -Type 'DWord' -Value 1 -Description 'Prevent Windows from automatically downloading and installing hardware driver updates'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\WindowsStore' -Name 'AutoDownload' -Type 'DWord' -Value 2 -Description 'Automatically download and install updates for apps from the Microsoft Store'

    # ============================================================================
    # EXPLORER SETTINGS
    # ============================================================================

    Remove-RegistryKey -Path 'HKCR:\*\shell\TakeOwnership' -Description 'Adds a right-click option to take ownership of files, folders, and drives with automatic permission elevation'
    try {
        $regContent_explorer_take_ownership = @'
Windows Registry Editor Version 5.00

; Created by: Shawn Brink
; Created on: January 28, 2015
; Updated on: February 25, 2024
; Tutorial: https://www.tenforums.com/tutorials/3841-add-take-ownership-context-menu-windows-10-a.html

[-HKEY_CLASSES_ROOT\*\shell\TakeOwnership]
[-HKEY_CLASSES_ROOT\*\shell\runas]

[HKEY_CLASSES_ROOT\*\shell\TakeOwnership]
@="Take Ownership"
"Extended"=-
"HasLUAShield"=""
"NoWorkingDirectory"=""
"NeverDefault"=""

[HKEY_CLASSES_ROOT\*\shell\TakeOwnership\command]
@="powershell -windowstyle hidden -command \"Start-Process cmd -ArgumentList '/c takeown /f \\\"%1\\\" && icacls \\\"%1\\\" /grant *S-1-3-4:F /t /c /l & pause' -Verb runAs\""
"IsolatedCommand"="powershell -windowstyle hidden -command \"Start-Process cmd -ArgumentList '/c takeown /f \\\"%1\\\" && icacls \\\"%1\\\" /grant *S-1-3-4:F /t /c /l & pause' -Verb runAs\""

[HKEY_CLASSES_ROOT\Directory\shell\TakeOwnership]
@="Take Ownership"
"AppliesTo"="NOT (System.ItemPathDisplay:=\"C:\\Users\" OR System.ItemPathDisplay:=\"C:\\ProgramData\" OR System.ItemPathDisplay:=\"C:\\Windows\" OR System.ItemPathDisplay:=\"C:\\Windows\\System32\" OR System.ItemPathDisplay:=\"C:\\Program Files\" OR System.ItemPathDisplay:=\"C:\\Program Files (x86)\")"
"Extended"=-
"HasLUAShield"=""
"NoWorkingDirectory"=""
"Position"="middle"

[HKEY_CLASSES_ROOT\Directory\shell\TakeOwnership\command]
@="powershell -windowstyle hidden -command \"$Y = ($null | choice).Substring(1,1); Start-Process cmd -ArgumentList ('/c takeown /f \\\"%1\\\" /r /d ' + $Y + ' && icacls \\\"%1\\\" /grant *S-1-3-4:F /t /c /l /q & pause') -Verb runAs\""
"IsolatedCommand"="powershell -windowstyle hidden -command \"$Y = ($null | choice).Substring(1,1); Start-Process cmd -ArgumentList ('/c takeown /f \\\"%1\\\" /r /d ' + $Y + ' && icacls \\\"%1\\\" /grant *S-1-3-4:F /t /c /l /q & pause') -Verb runAs\""

[HKEY_CLASSES_ROOT\Drive\shell\runas]
@="Take Ownership"
"Extended"=-
"HasLUAShield"=""
"NoWorkingDirectory"=""
"Position"="middle"
"AppliesTo"="NOT (System.ItemPathDisplay:=\"C:\\\")"

[HKEY_CLASSES_ROOT\Drive\shell\runas\command]
@="cmd.exe /c takeown /f \"%1\\\" /r /d y && icacls \"%1\\\" /grant *S-1-3-4:F /t /c & Pause"
"IsolatedCommand"="cmd.exe /c takeown /f \"%1\\\" /r /d y && icacls \"%1\\\" /grant *S-1-3-4:F /t /c & Pause"

'@
        $tempRegFile = Join-Path $env:TEMP "winhance_explorer-take-ownership_$((Get-Date).Ticks).reg"
        $regContent_explorer_take_ownership | Out-File -FilePath $tempRegFile -Encoding Unicode -Force
        reg import "$tempRegFile" 2>&1 | Out-Null
        if ($LASTEXITCODE -eq 0) {
            Write-Log "Adds a right-click option to take ownership of files, folders, and drives with automatic permission elevation" "SUCCESS"
        } else {
            Write-Log "Failed to import registry content for Adds a right-click option to take ownership of files, folders, and drives with automatic permission elevation" "ERROR"
        }
        Remove-Item $tempRegFile -Force -ErrorAction SilentlyContinue
    } catch {
        Write-Log "Error processing registry content for Adds a right-click option to take ownership of files, folders, and drives with automatic permission elevation: $($_.Exception.Message)" "ERROR"
    }

    Remove-RegistryKey -Path 'HKCR:\AllFilesystemObjects\shell\Windows.ShowFileExtensions' -Description 'Adds a right-click menu option to quickly toggle file extension visibility in File Explorer (only visible on the Classic Context Menu or Show More Options Menu in Windows 11)'
    try {
        $regContent_explorer_context_menu_toggle_extensions = @'
Windows Registry Editor Version 5.00

[-HKEY_CLASSES_ROOT\AllFilesystemObjects\shell\Windows.ShowFileExtensions]
[-HKEY_CLASSES_ROOT\Directory\Background\shell\Windows.ShowFileExtensions]

'@
        $tempRegFile = Join-Path $env:TEMP "winhance_explorer-context-menu-toggle-extensions_$((Get-Date).Ticks).reg"
        $regContent_explorer_context_menu_toggle_extensions | Out-File -FilePath $tempRegFile -Encoding Unicode -Force
        reg import "$tempRegFile" 2>&1 | Out-Null
        if ($LASTEXITCODE -eq 0) {
            Write-Log "Adds a right-click menu option to quickly toggle file extension visibility in File Explorer (only visible on the Classic Context Menu or Show More Options Menu in Windows 11)" "SUCCESS"
        } else {
            Write-Log "Failed to import registry content for Adds a right-click menu option to quickly toggle file extension visibility in File Explorer (only visible on the Classic Context Menu or Show More Options Menu in Windows 11)" "ERROR"
        }
        Remove-Item $tempRegFile -Force -ErrorAction SilentlyContinue
    } catch {
        Write-Log "Error processing registry content for Adds a right-click menu option to quickly toggle file extension visibility in File Explorer (only visible on the Classic Context Menu or Show More Options Menu in Windows 11): $($_.Exception.Message)" "ERROR"
    }

    Remove-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Shell Extensions\Blocked' -Name '{9F156763-7844-4DC4-B2B1-901F640F5155}' -Description 'Displays the Windows Terminal option when right-clicking folders and backgrounds in File Explorer'
    Remove-RegistryKey -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Explorer\MyComputer\NameSpace\{0DB7E03F-FC29-4DC6-9020-FF41B59E513A}' -Description 'Display the 3D Objects folder alongside Documents, Pictures, and other default folders'
    Remove-RegistryKey -Path 'HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Explorer\MyComputer\NameSpace\{0DB7E03F-FC29-4DC6-9020-FF41B59E513A}' -Description 'Display the 3D Objects folder alongside Documents, Pictures, and other default folders'
    Remove-RegistryKey -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Explorer\Desktop\NameSpace\{f874310e-b6b7-47dc-bc84-b9e6b38f5903}' -Description 'Display the Home folder in the navigation pane as a shortcut to your user profile folder'
    Remove-RegistryKey -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Explorer\Desktop\NameSpace\{e88865ea-0e1c-4e20-9aa6-edcd0212c87c}' -Description 'Display the Gallery folder in the navigation pane for quick access to all your photos and videos'
    Set-RegistryValue -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -Type 'DWord' -Value 1 -Description 'Enables support for file paths with up to 32,767 characters instead of the traditional 260-character limit'

    # ============================================================================
    # START MENU SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer' -Name 'HideRecommendedSection' -Type 'DWord' -Value 1 -Description 'Show or hide the lower section that displays recently opened files and suggested apps'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\PolicyManager\current\device\Start' -Name 'HideRecommendedSection' -Type 'DWord' -Value 1 -Description 'Show or hide the lower section that displays recently opened files and suggested apps'
    Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\PolicyManager\current\device\Education' -Name 'IsEducationEnvironment' -Type 'DWord' -Value 1 -Description 'Show or hide the lower section that displays recently opened files and suggested apps'
    Set-RegistryValue -Path 'HKLM:\Software\Policies\Microsoft\Windows\Explorer' -Name 'DisableSearchBoxSuggestions' -Type 'DWord' -Value 1 -Description 'Prevent web results from Bing from appearing when searching in the Start Menu, showing only local files and apps'

    # ============================================================================
    # TASKBAR SETTINGS
    # ============================================================================

    Set-RegistryValue -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' -Name 'HideSCAMeetNow' -Type 'DWord' -Value 1 -Description 'Controls Meet Now button visibility in the system tray'
    Set-RegistryValue -Path 'HKLM:\Software\Policies\Microsoft\Dsh' -Name 'AllowNewsAndInterests' -Type 'DWord' -Value 0 -Description 'Show the Widgets button that displays personalized news, weather, calendar, and other information'
    Set-RegistryValue -Path 'HKLM:\Software\Policies\Microsoft\Windows\Windows Feeds' -Name 'EnableFeeds' -Type 'DWord' -Value 0 -Description 'Show the News and Interests widget that displays headlines, weather, stocks, and other personalized content'

    # ============================================================================
    # START MENU LAYOUT
    # ============================================================================

    Write-Log "Configuring clean Start Menu layout..." "INFO"

    $buildNumber = [System.Environment]::OSVersion.Version.Build
    Write-Log "Detected Windows build: $buildNumber" "INFO"

    if ($buildNumber -ge 22000) {
        Write-Log "Applying Windows 11 clean Start Menu layout" "INFO"
        try {
            Set-RegistryValue -Path 'HKLM:\SOFTWARE\Microsoft\PolicyManager\current\device\Start' -Name 'ConfigureStartPins' -Type 'String' -Value '{"pinnedList":[]}' -Description 'Clean Start Menu'
            Write-Log "Windows 11 Start Menu layout applied successfully" "SUCCESS"
        } catch {
            Write-Log "Failed to apply Windows 11 Start Menu layout: $($_.Exception.Message)" "ERROR"
        }
    }
    else {
        Write-Log "Applying Windows 10 clean Start Menu layout" "INFO"
        try {
            # Step 1: Create directory
            $ShellPath = "C:\Users\Default\AppData\Local\Microsoft\Windows\Shell"
            New-Item -Path $ShellPath -ItemType Directory -Force | Out-Null
            Write-Log "Created directory: $ShellPath" "INFO"

            # Step 2: Create XML content
            $xmlContent = @'
<?xml version="1.0" encoding="utf-8"?>
<LayoutModificationTemplate Version="1" xmlns="http://schemas.microsoft.com/Start/2014/LayoutModification">
    <LayoutOptions StartTileGroupCellWidth="6" />
    <DefaultLayoutOverride>
        <StartLayoutCollection>
            <StartLayout GroupCellWidth="6" xmlns="http://schemas.microsoft.com/Start/2014/FullDefaultLayout" />
        </StartLayoutCollection>
    </DefaultLayoutOverride>
</LayoutModificationTemplate>
'@

            # Step 3: Save XML file
            $XmlPath = "$ShellPath\LayoutModification.xml"
            $xmlContent | Out-File -FilePath $XmlPath -Encoding UTF8
            Write-Log "SUCCESS: Clean Start Menu Template created at $XmlPath" "SUCCESS"
        } catch {
            Write-Log "Failed to create Start Menu Template: $($_.Exception.Message)" "ERROR"
        }
    }


    # ============================================================================
    # USER CUSTOMIZATIONS SCHEDULED TASK
    # ============================================================================

    Write-Log "Registering UserCustomizations scheduled task..." "INFO"
    try {
        $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -NoProfile -WindowStyle Hidden -File C:\ProgramData\Winhance\Unattend\Scripts\Winhancements.ps1 -UserCustomizations"
        $trigger = New-ScheduledTaskTrigger -AtLogOn
        $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -ExecutionTimeLimit 0
        $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
        Register-ScheduledTask -TaskName "WinhanceUserCustomizations" -TaskPath "\Winhance" -Action $action -Trigger $trigger -Settings $settings -Principal $principal -Force | Out-Null
        Write-Log "Registered scheduled task: WinhanceUserCustomizations" "SUCCESS"
    } catch {
        Write-Log "Failed to register UserCustomizations task: `$(`$_.Exception.Message)" "ERROR"
    }


    # ============================================================================
    # ADD YOUR SYSTEM WIDE POWERSHELL SCRIPT CONTENTS BELOW
    # ============================================================================

    # Start here

    # End here

}

if ($UserCustomizations) {

    $runningAsSystem = ($env:USERNAME -eq "SYSTEM" -or $env:USERPROFILE -like "*\system32\config\systemprofile")
    $targetUserSID = $null

    if ($runningAsSystem) {
        Write-Log "UserCustomizations running as SYSTEM, detecting logged-in user..." "INFO"

        if (-not (Test-Path "HKU:\")) {
            New-PSDrive -PSProvider Registry -Name HKU -Root HKEY_USERS -ErrorAction SilentlyContinue | Out-Null
        }

        $targetUser = Get-TargetUser
        if ($targetUser) {
            $targetUserSID = Get-UserSID -Username $targetUser
            if ($targetUserSID) {
                Write-Log "Target user: $targetUser (SID: $targetUserSID)" "INFO"

                Remove-PSDrive -Name HKCU -ErrorAction SilentlyContinue
                New-PSDrive -PSProvider Registry -Name HKCU -Root "HKEY_USERS\$targetUserSID" -ErrorAction Stop | Out-Null
                Write-Log "Remapped HKCU to target user's registry hive" "INFO"
            } else {
                Write-Log "Failed to get SID for user: $targetUser" "ERROR"
                exit 1
            }
        } else {
            Write-Log "No logged-in user detected, UserCustomizations cannot proceed" "WARNING"
            exit 1
        }
    } else {
        Write-Log "UserCustomizations running as user" "INFO"
    }

    $markerPath = "HKCU:\Software\Winhance"
    $markerName = "UserCustomizationsApplied"
    $alreadyApplied = $false

    try {
        if (Test-Path $markerPath) {
            $value = Get-ItemProperty -Path $markerPath -Name $markerName -ErrorAction SilentlyContinue
            if ($value.$markerName -eq 1) {
                $alreadyApplied = $true
            }
        }
    } catch { }

    if ($alreadyApplied) {
        Write-Log "User customizations have already been applied for this user" "INFO"
        Write-Log "To re-apply these settings, delete the registry value: $markerPath\$markerName" "INFO"
    } else {
        Write-Log "Applying user customizations for the first time..." "INFO"


        # ============================================================================
        # GAMING & PERFORMANCE SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\GameBar' -Name 'AutoGameModeEnabled' -Type 'DWord' -Value 1 -Description 'Optimize your PC for play by turning things off in the background'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Mouse' -Name 'MouseSpeed' -Type 'String' -Value '0' -Description 'Adjust cursor speed based on movement velocity (mouse acceleration). Most competitive gamers disable this for consistent aiming in FPS games'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Serialize' -Name 'StartupDelayInMSec' -Type 'DWord' -Value 10000 -Description 'Delay startup applications by 10 seconds after boot to improve initial system responsiveness. Windows becomes usable faster, but your startup apps take longer to load'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\AppPrivacy' -Name 'LetAppsRunInBackground' -Type 'DWord' -Value 0 -Description 'Allow apps to receive notifications, update data, and perform tasks even when not actively in use'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\StorageSense' -Name 'AllowStorageSenseGlobal' -Type 'DWord' -Value 0 -Description 'Automatically free up disk space by removing temporary files, emptying the recycle bin, and managing downloads'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Search\Preferences' -Name 'WholeFileSystem' -Type 'DWord' -Value 0 -Description 'Search your entire file system instead of only indexed locations. This provides more complete results but is significantly slower than indexed search and increases disk activity'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Desktop' -Name 'JPEGImportQuality' -Type 'DWord' -Value 100 -Description 'Allow Windows to compress wallpapers to save disk space and improve performance. Only affects images in JPEG format.'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Desktop' -Name 'MenuShowDelay' -Type 'String' -Value '0' -Description 'Add a brief delay before displaying menus, or show them instantly for faster navigation'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'MultiTaskingAltTabFilter' -Type 'DWord' -Value 3 -Description 'Show only traditional open windows in Alt+Tab instead of including Microsoft Edge tabs and other Windows suggestions'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\DirectX\UserGpuPreferences' -Name 'DirectXUserGlobalSettings' -Type 'String' -Value 'SwapEffectUpgradeEnable=1;' -Description 'Reduce latency and use advanced features in compatible games by using DirectX flip presentation model'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\DirectX\UserGpuPreferences' -Name 'VRROptimizeEnable' -Type 'DWord' -Value 0 -Description 'Enable VRR (G-Sync/FreeSync) optimizations for smoother gameplay on compatible monitors. Disable only if experiencing issues with VRR displays'
        Set-RegistryValue -Path 'HKCU:\System\GameConfigStore' -Name 'GameDVR_FSEBehaviorMode' -Type 'DWord' -Value 0 -Description 'Allow Windows to optimize games running in fullscreen mode. Disabling can fix performance issues or stuttering in some older games that don''t work well with borderless fullscreen optimization'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\DWM' -Name 'CompositionPolicy' -Type 'DWord' -Value 1 -Description 'Enable visual effects managed by the Desktop Window Manager. Disabling may provide minor performance gains on older hardware but will break Aero effects'
        Set-RegistryValue -Path 'HKCU:\System\GameConfigStore' -Name 'GameDVR_Enabled' -Type 'DWord' -Value 0 -Description 'Record gameplay clips and take screenshots using the Xbox Game Bar overlay. Disabling reduces CPU/GPU usage and can improve frame rates'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\GameBar' -Name 'UseNexusForGameBarEnabled' -Type 'DWord' -Value 0 -Description 'Allow your Xbox/compatible controller to open Game Bar by pressing the Xbox button. Disable to prevent accidental Game Bar activation during gaming'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\GameBar' -Name 'ShowStartupPanel' -Type 'DWord' -Value 0 -Description 'Show tips and hints about Game Bar features when opening the overlay. Disabling reduces distractions during gameplay'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects' -Name 'VisualFXSetting' -Type 'DWord' -Value 3 -Description 'Choose how Windows displays visual effects'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 4 -BitMask 0x02 -SetBit $False -Description 'Enables animation effects for controls and UI elements'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Desktop\WindowMetrics' -Name 'MinAnimate' -Type 'String' -Value '0' -Description 'Shows smooth animation when windows are minimized or maximized'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'TaskbarAnimations' -Type 'DWord' -Value 0 -Description 'Controls taskbar animation effects for opening, closing, and switching windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\DWM' -Name 'EnableAeroPeek' -Type 'DWord' -Value 1 -Description 'Allows peeking at desktop when hovering over Show Desktop button'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 0 -BitMask 0x02 -SetBit $False -Description 'Animates menus when they appear using fade or slide effects'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 1 -BitMask 0x08 -SetBit $False -Description 'Animates tooltips when they appear using fade or slide effects'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 1 -BitMask 0x04 -SetBit $False -Description 'Fades menu items after selection before closing the menu'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\DWM' -Name 'AlwaysHibernateThumbnails' -Type 'DWord' -Value 0 -Description 'Saves thumbnail previews of taskbar windows for faster display'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 1 -BitMask 0x20 -SetBit $False -Description 'Displays shadow effect underneath the mouse cursor'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 2 -BitMask 0x04 -SetBit $False -Description 'Displays shadow effects underneath windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'IconsOnly' -Type 'DWord' -Value 0 -Description 'Displays image and document previews instead of generic file icons'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ListviewAlphaSelect' -Type 'DWord' -Value 1 -Description 'Display a semi-transparent selection box when dragging to select multiple files or items'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Desktop' -Name 'DragFullWindows' -Type 'String' -Value '1' -Description 'Displays window contents when dragging instead of just an outline'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 0 -BitMask 0x04 -SetBit $False -Description 'Animates combo boxes when they open with a sliding effect'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Desktop' -Name 'FontSmoothing' -Type 'String' -Value '2' -Description 'Apply anti-aliasing to text for smoother, more readable fonts on screen'
        Set-BinaryBit -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -ByteIndex 0 -BitMask 0x08 -SetBit $False -Description 'Enables smooth scrolling in list boxes instead of jumping'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ListviewShadow' -Type 'DWord' -Value 0 -Description 'Add shadow effects behind desktop icon text to improve readability against backgrounds'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Narrator\NoRoam' -Name 'WinEnterLaunchEnabled' -Type 'DWord' -Value 0 -Description 'Enable the Win+Ctrl+Enter keyboard shortcut to quickly launch Windows Narrator screen reader'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility\StickyKeys' -Name 'Flags' -Type 'String' -Value '2' -Description 'Enable the keyboard shortcut to activate StickyKeys by pressing the Shift key five times'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility\Keyboard Response' -Name 'Flags' -Type 'String' -Value '2' -Description 'Enable the keyboard shortcut to activate FilterKeys by holding the right Shift key for 8 seconds'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility\ToggleKeys' -Name 'Flags' -Type 'String' -Value '34' -Description 'Enable the keyboard shortcut to activate ToggleKeys by holding Num Lock for 5 seconds, which plays sounds when Caps/Num/Scroll Lock are pressed'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility\MouseKeys' -Name 'Flags' -Type 'String' -Value '130' -Description 'Enable the keyboard shortcut to activate MouseKeys, which allows using the numeric keypad to control the mouse pointer'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility\HighContrast' -Name 'Flags' -Type 'String' -Value '4194' -Description 'Enable the keyboard shortcut to activate High Contrast mode by pressing Left Alt + Left Shift + Print Screen'

        # ============================================================================
        # NOTIFICATIONS SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\PushNotifications' -Name 'ToastEnabled' -Type 'DWord' -Value 0 -Description 'Get notifications from apps and other senders in Windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -Name 'NOC_GLOBAL_SETTING_ALLOW_NOTIFICATION_SOUND' -Type 'DWord' -Value 0 -Description 'Play audio alerts when notifications arrive from apps and system senders'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -Name 'NOC_GLOBAL_SETTING_ALLOW_TOASTS_ABOVE_LOCK' -Type 'DWord' -Value 0 -Description 'Display toast notifications on the lock screen when your device is locked'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\PushNotifications' -Name 'LockScreenToastEnabled' -Type 'DWord' -Value 0 -Description 'Display toast notifications on the lock screen when your device is locked'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings' -Name 'NOC_GLOBAL_SETTING_ALLOW_CRITICAL_TOASTS_ABOVE_LOCK' -Type 'DWord' -Value 0 -Description 'Display critical notifications like reminders and VoIP calls when your device is locked'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowNotificationIcon' -Type 'DWord' -Value 0 -Description 'Display the notification bell icon in the system tray'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-310093Enabled' -Type 'DWord' -Value 0 -Description 'Show what''s new and suggested after updates and when signed in'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\UserProfileEngagement' -Name 'ScoobeSystemSettingEnabled' -Type 'DWord' -Value 0 -Description 'Show suggestions to help you complete device setup and optimize Windows features'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-338389Enabled' -Type 'DWord' -Value 0 -Description 'Show helpful tips and suggestions while using Windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SystemPaneSuggestionsEnabled' -Type 'DWord' -Value 0 -Description 'Display helpful suggestions in the Action Center and Notification Center'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings\Windows.SystemToast.CapabilityAccess' -Name 'Enabled' -Type 'DWord' -Value 0 -Description 'Show notifications when apps request access to system capabilities and permissions'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings\Windows.SystemToast.StartupApp' -Name 'Enabled' -Type 'DWord' -Value 0 -Description 'Show notifications when apps are added to your Windows startup list'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\CapabilityAccessManager\ConsentStore\location' -Name 'ShowGlobalPrompts' -Type 'DWord' -Value 1 -Description 'Show notifications when apps attempt to access your location information'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Desktop' -Name 'DstNotification' -Type 'DWord' -Value 0 -Description 'Show notifications when daylight saving time changes occur'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Windows Defender Security Center\Notifications' -Name 'DisableNotifications' -Type 'DWord' -Value 0 -Description 'Show all notifications from Windows Security about threats, scans, and protection status'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Windows Defender Security Center\Notifications' -Name 'DisableEnhancedNotifications' -Type 'DWord' -Value 0 -Description 'Show all notifications from Windows Security about threats, scans, and protection status'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Notifications\Settings\Windows.SystemToast.SecurityAndMaintenance' -Name 'Enabled' -Type 'DWord' -Value 1 -Description 'Show notifications from the Security and Maintenance Action Center'

        # ============================================================================
        # PRIVACY & SECURITY SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WorkplaceJoin' -Name 'BlockAADWorkplaceJoin' -Type 'DWord' -Value 1 -Description 'Blocks the ''Allow my organization to manage my device'' and ''No, sign in to this app only'' pop-up messages'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting' -Name 'Disabled' -Type 'DWord' -Value 1 -Description 'Stops Windows from collecting and sending crash reports and error information to Microsoft'
        Set-RegistryValue -Path 'HKCU:\Software\Winhance\Settings' -Name 'AdsPromotionalContentMode' -Type 'DWord' -Value 1 -Description 'Controls all advertising, suggestions, and promotional content throughout Windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'ContentDeliveryAllowed' -Type 'DWord' -Value 0 -Description 'Allows Windows to deliver promotional content and automatically install suggested apps'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContentEnabled' -Type 'DWord' -Value 0 -Description 'Enables promotional content subscriptions from Microsoft and partners throughout Windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'FeatureManagementEnabled' -Type 'DWord' -Value 0 -Description 'Enables Windows feature management functionality for promotional features and automatic app installations'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SoftLandingEnabled' -Type 'DWord' -Value 0 -Description 'Displays tips and notifications about Windows features as you use the operating system'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'OemPreInstalledAppsEnabled' -Type 'DWord' -Value 0 -Description 'Prevents OEM manufacturers from automatically installing bloatware apps'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'PreInstalledAppsEnabled' -Type 'DWord' -Value 0 -Description 'Prevents Microsoft from automatically installing suggested apps'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'PreInstalledAppsEverEnabled' -Type 'DWord' -Value 0 -Description 'Disables tracking of whether pre-installed apps were ever enabled'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SilentInstalledAppsEnabled' -Type 'DWord' -Value 0 -Description 'Prevents apps from being silently installed in the background'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'RotatingLockScreenEnabled' -Type 'DWord' -Value 0 -Description 'Displays rotating Windows Spotlight images on your lock screen instead of a static background'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'RotatingLockScreenOverlayEnabled' -Type 'DWord' -Value 0 -Description 'Displays fun facts, tips, and tricks as an overlay on your lock screen'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SlideshowEnabled' -Type 'DWord' -Value 0 -Description 'Enables slideshow option for lock screen background'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\AdvertisingInfo' -Name 'Enabled' -Type 'DWord' -Value 0 -Description 'Windows generates a unique advertising ID that apps use to track your activity and deliver personalized ads based on your behavior across different apps'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\AdvertisingInfo' -Name 'DisabledByGroupPolicy' -Type 'DWord' -Value 1 -Description 'Windows generates a unique advertising ID that apps use to track your activity and deliver personalized ads based on your behavior across different apps'
        Set-RegistryValue -Path 'HKCU:\Control Panel\International\User Profile' -Name 'HttpAcceptLanguageOptOut' -Type 'DWord' -Value 1 -Description 'Allows websites to access your language preferences so they can automatically display content in your preferred language without requiring manual configuration on each site'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'Start_TrackProgs' -Type 'DWord' -Value 0 -Description 'Windows records which apps you use most frequently to personalize your Start menu and improve search results, making your most-used apps more accessible'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-338393Enabled' -Type 'DWord' -Value 0 -Description 'Microsoft displays promotional content, tips, and feature suggestions within the Windows Settings app to help you discover new features and functionality'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-353694Enabled' -Type 'DWord' -Value 0 -Description 'Microsoft displays promotional content, tips, and feature suggestions within the Windows Settings app to help you discover new features and functionality'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-353696Enabled' -Type 'DWord' -Value 0 -Description 'Microsoft displays promotional content, tips, and feature suggestions within the Windows Settings app to help you discover new features and functionality'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\SystemSettings\AccountNotifications' -Name 'EnableAccountNotifications' -Type 'DWord' -Value 0 -Description 'Shows account notifications in the Settings app, including prompts to reauthenticate, backup your device, and manage subscriptions'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Speech_OneCore\Settings\OnlineSpeechPrivacy' -Name 'HasAccepted' -Type 'DWord' -Value 0 -Description 'Use your voice for apps using Microsoft''s online speech recognition technology'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\InputPersonalization' -Name 'AllowInputPersonalization' -Type 'DWord' -Value 0 -Description 'Use your voice for apps using Microsoft''s online speech recognition technology'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Narrator\NoRoam' -Name 'OnlineServicesEnabled' -Type 'DWord' -Value 0 -Description 'Allow Narrator to use Microsoft cloud services for features like intelligent image descriptions and enhanced voice models'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Narrator\NoRoam' -Name 'ScriptingEnabled' -Type 'DWord' -Value 0 -Description 'Allow Narrator to execute scripts for automation and custom functionality'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\CPSS\Store\InkingAndTypingPersonalization' -Name 'Value' -Type 'DWord' -Value 0 -Description 'Uses your typing history and handwriting patterns to create a custom dictionary (turning off will clear all words in your custom dictionary)'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Personalization\Settings' -Name 'AcceptedPrivacyPolicy' -Type 'DWord' -Value 0 -Description 'Uses your typing history and handwriting patterns to create a custom dictionary (turning off will clear all words in your custom dictionary)'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\InputPersonalization' -Name 'RestrictImplicitTextCollection' -Type 'DWord' -Value 1 -Description 'Uses your typing history and handwriting patterns to create a custom dictionary (turning off will clear all words in your custom dictionary)'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\InputPersonalization\TrainedDataStore' -Name 'HarvestContacts' -Type 'DWord' -Value 0 -Description 'Uses your typing history and handwriting patterns to create a custom dictionary (turning off will clear all words in your custom dictionary)'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Diagnostics\DiagTrack' -Name 'ShowedToastAtLevel' -Type 'DWord' -Value 1 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\DataCollection' -Name 'AllowTelemetry' -Type 'DWord' -Value 0 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'AllowTelemetry' -Type 'DWord' -Value 1 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\DataCollection' -Name 'MaxTelemetryAllowed' -Type 'DWord' -Value 1 -Description 'Send diagnostic data to Microsoft to help improve Windows and keep it secure'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Input\TIPC' -Name 'Enabled' -Type 'DWord' -Value 0 -Description 'Send optional inking and typing diagnostic data to Microsoft'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\CPSS\Store\ImproveInkingAndTyping' -Name 'Value' -Type 'DWord' -Value 0 -Description 'Send optional inking and typing diagnostic data to Microsoft'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Privacy' -Name 'TailoredExperiencesWithDiagnosticDataEnabled' -Type 'DWord' -Value 0 -Description 'Let Microsoft use your diagnostic data to show personalized tips, ads and recommendations'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Windows\CloudContent' -Name 'DisableTailoredExperiencesWithDiagnosticData' -Type 'DWord' -Value 1 -Description 'Let Microsoft use your diagnostic data to show personalized tips, ads and recommendations'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\DataCollection' -Name 'DoNotShowFeedbackNotifications' -Type 'DWord' -Value 1 -Description 'Let Windows ask you to provide feedback on experiences in Windows'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'PublishUserActivities' -Type 'DWord' -Value 0 -Description 'Allows you to jump back into what you were doing with apps, docs, or other activities on startup'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-353698Enabled' -Type 'DWord' -Value 0 -Description 'Shows suggestions in the Windows 10 Timeline feature'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\SearchSettings' -Name 'IsDeviceSearchHistoryEnabled' -Type 'DWord' -Value 0 -Description 'Improves search results by allowing Windows Search to store your search history locally on this device (Does not clear existing history)'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\SearchSettings' -Name 'IsDynamicSearchBoxEnabled' -Type 'DWord' -Value 0 -Description 'See content suggestions in search'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\SearchSettings' -Name 'IsMSACloudSearchEnabled' -Type 'DWord' -Value 0 -Description 'Allow Windows Search to show results from apps and services that you are signed in to with your Microsoft account'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\SearchSettings' -Name 'IsAADCloudSearchEnabled' -Type 'DWord' -Value 0 -Description 'Allow Windows Search to show results from apps and services that you are signed in to with your work or school account'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\Windows Search' -Name 'AllowCortana' -Type 'DWord' -Value 0 -Description 'Enables Microsoft''s Cortana virtual assistant for voice commands and searches'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\LocationAndSensors' -Name 'DisableLocation' -Type 'DWord' -Value 1 -Description 'Allows Windows and apps to access your device location for location-based features'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\OneDrive' -Name 'KFMBlockOptIn' -Type 'DWord' -Value 1 -Description 'Prevents OneDrive from automatically backing up important folders (Documents, Pictures, Desktop, etc.)'

        # ============================================================================
        # SOUND SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Multimedia\Audio' -Name 'UserDuckingPreference' -Type 'DWord' -Value 3 -Description 'Automatically lower volume of media and apps when Windows detects communication activity'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Narrator\NoRoam' -Name 'DuckAudio' -Type 'DWord' -Value 0 -Description 'Allow Narrator to automatically lower the volume of other applications when it speaks'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility' -Name 'Sound on Activation' -Type 'DWord' -Value 0 -Description 'Play sounds when accessibility features like StickyKeys or FilterKeys are activated'
        Set-RegistryValue -Path 'HKCU:\Control Panel\Accessibility' -Name 'Warning Sounds' -Type 'DWord' -Value 0 -Description 'Play warning sounds when attempting to activate accessibility features or when accessibility-related events occur'

        # ============================================================================
        # WINDOWS UPDATE SETTINGS
        # ============================================================================

        Remove-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'NoAutoUpdate' -Description 'Control how Windows updates are installed on your system'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'AUOptions' -Type 'DWord' -Value 2 -Description 'Control how Windows updates are installed on your system'
        Remove-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'NoAUShutdownOption' -Description 'Control how Windows updates are installed on your system'
        Remove-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'AlwaysAutoRebootAtScheduledTime' -Description 'Control how Windows updates are installed on your system'
        Remove-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'AutoInstallMinorUpdates' -Description 'Control how Windows updates are installed on your system'
        Remove-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'UseWUServer' -Description 'Control how Windows updates are installed on your system'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\DeliveryOptimization' -Name 'DODownloadMode' -Type 'DWord' -Value 99 -Description 'Share downloaded updates with other PCs on your network or the internet to reduce bandwidth usage'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU' -Name 'NoAutoRebootWithLoggedOnUsers' -Type 'DWord' -Value 1 -Description 'Prevents automatic restarts after installing updates when users are logged on'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name 'SetUpdateNotificationLevel' -Type 'DWord' -Value 1 -Description 'Show or hide notifications about available updates and update progress'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate' -Name 'ExcludeWUDriversInQualityUpdate' -Type 'DWord' -Value 1 -Description 'Prevent Windows from automatically downloading and installing hardware driver updates'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\WindowsStore' -Name 'AutoDownload' -Type 'DWord' -Value 2 -Description 'Automatically download and install updates for apps from the Microsoft Store'

        # ============================================================================
        # EXPLORER SETTINGS
        # ============================================================================

        Remove-RegistryValue -Path 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer' -Name 'link' -Description 'Prevents Windows from appending ''- Shortcut'' text to newly created shortcut file names'
        New-RegistryKey -Path 'HKCU:\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32' -Description 'Use the Windows 10-style right-click menu with all options visible instead of the simplified Windows 11 menu'
        Set-RegistryValue -Path 'HKCU:\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32' -Name '(Default)' -Type 'String' -Value '' -Description 'Use the Windows 10-style right-click menu with all options visible instead of the simplified Windows 11 menu'
        Remove-RegistryKey -Path 'HKCU:\Software\Classes\.bmp' -Description 'Restore the legacy Windows Photo Viewer and set it as the default program for common image file formats'
        try {
            $regContent_explorer_enable_photo_viewer = @'
Windows Registry Editor Version 5.00

[-HKEY_CURRENT_USER\SOFTWARE\Classes\.bmp]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.cr2]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.dib]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.gif]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.ico]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.jfif]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.jpe]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.jpeg]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.jpg]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.jxr]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.png]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.tif]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.tiff]
[-HKEY_CURRENT_USER\SOFTWARE\Classes\.wdp]

[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.bmp\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.cr2\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.dib\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.gif\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.ico\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jfif\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jpe\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jpeg\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jpg\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jxr\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.png\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.tif\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.tiff\OpenWithProgids]
[-HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.wdp\OpenWithProgids]

'@
            $tempRegFile = Join-Path $env:TEMP "winhance_explorer-enable-photo-viewer_$((Get-Date).Ticks).reg"
            $regContent_explorer_enable_photo_viewer | Out-File -FilePath $tempRegFile -Encoding Unicode -Force
            reg import "$tempRegFile" 2>&1 | Out-Null
            if ($LASTEXITCODE -eq 0) {
                Write-Log "Restore the legacy Windows Photo Viewer and set it as the default program for common image file formats" "SUCCESS"
            } else {
                Write-Log "Failed to import registry content for Restore the legacy Windows Photo Viewer and set it as the default program for common image file formats" "ERROR"
            }
            Remove-Item $tempRegFile -Force -ErrorAction SilentlyContinue
        } catch {
            Write-Log "Error processing registry content for Restore the legacy Windows Photo Viewer and set it as the default program for common image file formats: $($_.Exception.Message)" "ERROR"
        }

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'HideMergeConflicts' -Type 'DWord' -Value 0 -Description 'Automatically merges folders with same name without confirmation dialog'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowSuperHidden' -Type 'DWord' -Value 0 -Description 'Displays system files marked with the SuperHidden attribute'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'SeparateProcess' -Type 'DWord' -Value 0 -Description 'Runs each Explorer window in its own process to prevent crashes affecting all windows'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'PersistBrowsers' -Type 'DWord' -Value 0 -Description 'Reopens Explorer windows that were open when you last shut down or logged off'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowDriveLettersFirst' -Type 'DWord' -Value 4 -Description 'Displays drive letters (C:, D:) before drive names in This PC'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowEncryptCompressedColor' -Type 'DWord' -Value 1 -Description 'Displays encrypted files in green and compressed files in blue'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowInfoTip' -Type 'DWord' -Value 1 -Description 'Displays tooltip with item details when hovering over files and folders'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowPreviewHandlers' -Type 'DWord' -Value 0 -Description 'Enables file content preview when selecting files in Explorer'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowStatusBar' -Type 'DWord' -Value 1 -Description 'Displays bar at bottom showing item count and selected file sizes'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowSyncProviderNotifications' -Type 'DWord' -Value 0 -Description 'Displays cloud sync status notifications from OneDrive and other sync providers'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'AutoCheckSelect' -Type 'DWord' -Value 0 -Description 'Adds checkboxes next to items for easier multi-selection'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'SharingWizardOn' -Type 'DWord' -Value 0 -Description 'Shows simplified sharing dialog instead of advanced security permissions'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'TypeAhead' -Type 'DWord' -Value 0 -Description 'Chooses whether typing selects matching items or searches automatically'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'NavPaneShowAllCloudStates' -Type 'DWord' -Value 0 -Description 'Shows cloud sync status icons for OneDrive files in navigation pane'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'NavPaneExpandToCurrentFolder' -Type 'DWord' -Value 0 -Description 'Automatically expands navigation tree to highlight current folder location'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'NavPaneShowAllFolders' -Type 'DWord' -Value 0 -Description 'Shows all folders in the navigation pane'
        Set-RegistryValue -Path 'HKCU:\Software\Classes\CLSID\{031E4825-7B94-4dc3-B131-E946B44C8DD5}' -Name 'System.IsPinnedToNameSpaceTree' -Type 'DWord' -Value 0 -Description 'Displays Libraries container grouping Documents, Music, Pictures, and Videos'

        # ============================================================================
        # START MENU SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'Start_Layout' -Type 'DWord' -Value 1 -Description 'Choose whether the Start Menu shows more pinned apps, more recommendations, or a balanced default layout'
        Set-RegistryValue -Path 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\Explorer' -Name 'HideRecommendedSection' -Type 'DWord' -Value 1 -Description 'Show or hide the lower section that displays recently opened files and suggested apps'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Start' -Name 'ShowAllPinsList' -Type 'DWord' -Value 1 -Description 'Automatically expand to show all pinned apps instead of requiring you to click ''All apps'''
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Start' -Name 'ShowRecentList' -Type 'DWord' -Value 0 -Description 'Display a list of recently installed applications at the top of the All Apps list'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Start' -Name 'ShowFrequentList' -Type 'DWord' -Value 0 -Description 'Display your frequently launched applications at the top of the All Apps list for quick access'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'Start_TrackProgs' -Type 'DWord' -Value 0 -Description 'Display your frequently launched applications at the top of the All Apps list for quick access'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\ContentDeliveryManager' -Name 'SubscribedContent-338388Enabled' -Type 'DWord' -Value 0 -Description 'Display app suggestions and promotional content from the Microsoft Store in the Start Menu'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'Start_TrackDocs' -Type 'DWord' -Value 0 -Description 'Display your recently opened documents and files in the Start Menu''s Recommended section for quick access'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'Start_IrisRecommendations' -Type 'DWord' -Value 0 -Description 'Display personalized suggestions from Windows for tips, app shortcuts, and Microsoft Store apps in the Recommended section'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'Start_AccountNotifications' -Type 'DWord' -Value 0 -Description 'Display notifications about Microsoft account sign-in, sync status, and account-related suggestions'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Windows\Explorer' -Name 'DisableSearchBoxSuggestions' -Type 'DWord' -Value 1 -Description 'Prevent web results from Bing from appearing when searching in the Start Menu, showing only local files and apps'

        # ============================================================================
        # TASKBAR SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Search' -Name 'SearchboxTaskbarMode' -Type 'DWord' -Value 0 -Description 'Choose how the Windows search appears on your taskbar: hidden, icon only, icon with label, or full search box'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Search' -Name 'SearchboxTaskbarMode' -Type 'DWord' -Value 0 -Description 'Choose how the Windows search appears on your taskbar: hidden, icon only, or full search box'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'TaskbarAl' -Type 'DWord' -Value 0 -Description 'Align taskbar icons to the left (classic Windows style) or center (Windows 11 default)'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Windows\Explorer' -Name 'HideSCAMeetNow' -Type 'DWord' -Value 1 -Description 'Controls Meet Now button visibility in the system tray'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' -Name 'HideSCAMeetNow' -Type 'DWord' -Value 1 -Description 'Controls Meet Now button visibility in the system tray'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer' -Name 'EnableAutoTray' -Type 'DWord' -Value 0 -Description 'Show all system tray icons directly on the taskbar instead of hiding them in the overflow menu (up arrow)'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ShowTaskViewButton' -Type 'DWord' -Value 0 -Description 'Show the Task View button for managing virtual desktops and viewing all open windows at once'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Dsh' -Name 'AllowNewsAndInterests' -Type 'DWord' -Value 0 -Description 'Show the Widgets button that displays personalized news, weather, calendar, and other information'
        Set-RegistryValue -Path 'HKCU:\Software\Policies\Microsoft\Windows\Windows Feeds' -Name 'EnableFeeds' -Type 'DWord' -Value 0 -Description 'Show the News and Interests widget that displays headlines, weather, stocks, and other personalized content'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'TaskbarAcrylicOpacity' -Type 'DWord' -Value 1 -Description 'Controls the transparency of the taskbar'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'TaskbarSmallIcons' -Type 'DWord' -Value 1 -Description 'Reduce the height of the taskbar by using smaller icons, giving you more screen space'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced\TaskbarDeveloperSettings' -Name 'TaskbarEndTask' -Type 'DWord' -Value 1 -Description 'Adds an ''End Task'' option when right-clicking applications on the taskbar for quick termination'

        # ============================================================================
        # WINDOWS THEME SETTINGS
        # ============================================================================

        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize' -Name 'AppsUseLightTheme' -Type 'DWord' -Value 0 -Description 'Choose between Light and Dark mode for Windows and apps'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize' -Name 'SystemUsesLightTheme' -Type 'DWord' -Value 0 -Description 'Choose between Light and Dark mode for Windows and apps'
        Set-RegistryValue -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize' -Name 'EnableTransparency' -Type 'DWord' -Value 0 -Description 'Enable translucent effects for the Start Menu, taskbar, and other Windows interface elements'

        Write-Log "Setting wallpaper based on Windows version and theme..." "INFO"
        $buildNumber = [System.Environment]::OSVersion.Version.Build
        $wallpaperPath = $null

        if ($buildNumber -ge 22000) {
            $themeKey = 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize'
            $lightTheme = $false

            if (Test-Path $themeKey) {
                $value = Get-ItemProperty -Path $themeKey -Name 'SystemUsesLightTheme' -ErrorAction SilentlyContinue
                if ($value.SystemUsesLightTheme -eq 1) {
                    $lightTheme = $true
                }
            }

            if ($lightTheme) {
                $wallpaperPath = 'C:\Windows\Web\Wallpaper\Windows\img0.jpg'
            } else {
                $wallpaperPath = 'C:\Windows\Web\Wallpaper\Windows\img19.jpg'
            }
        } else {
            $wallpaperPath = 'C:\Windows\Web\4K\Wallpaper\Windows\img0_3840x2160.jpg'
        }

        if (-not (Test-Path $wallpaperPath)) {
            Write-Log "Wallpaper file not found: $wallpaperPath" "WARNING"
        } else {
            try {
                $desktopKey = 'HKCU:\Control Panel\Desktop'
                Set-ItemProperty -Path $desktopKey -Name Wallpaper -Value $wallpaperPath -Type String -Force
                Set-ItemProperty -Path $desktopKey -Name WallpaperStyle -Value '10' -Type String -Force
                Set-ItemProperty -Path $desktopKey -Name TileWallpaper -Value '0' -Type String -Force

                Remove-ItemProperty -Path $desktopKey -Name 'TranscodedImageCache' -ErrorAction SilentlyContinue
                Remove-ItemProperty -Path $desktopKey -Name 'TranscodedImageCache_000' -ErrorAction SilentlyContinue

                Write-Log "Wallpaper configured: $wallpaperPath" "SUCCESS"
            } catch {
                Write-Log "Failed to set wallpaper: $($_.Exception.Message)" "ERROR"
            }
        }


        # ============================================================================
        # ADD YOUR USER SPECIFIC POWERSHELL SCRIPT CONTENTS BELOW
        # ============================================================================

        # Start here

        # End here


        try {
            if (-not (Test-Path $markerPath)) {
                New-Item -Path $markerPath -Force | Out-Null
            }
            Set-ItemProperty -Path $markerPath -Name $markerName -Value 1 -Type DWord -Force
            Write-Log "User customizations completed and marked as applied" "SUCCESS"
            Write-Log "Note: User customizations will not run again unless $markerPath\$markerName is deleted" "INFO"
        } catch {
            Write-Log "Failed to create completion marker: $($_.Exception.Message)" "WARNING"
        }
    }

    if ($runningAsSystem -and $targetUserSID) {
        try {
            Remove-PSDrive -Name HKCU -ErrorAction SilentlyContinue
            New-PSDrive -PSProvider Registry -Name HKCU -Root HKEY_CURRENT_USER -ErrorAction SilentlyContinue | Out-Null
            Write-Log "Restored HKCU PSDrive" "INFO"
        } catch { }
    }

    if (-not $alreadyApplied) {
        Write-Log "Rebooting system to apply user customizations..." "INFO"
        # Wait 20 seconds to give the FirstLogon phase some more time before restarting
        shutdown.exe /r /t 20
    } else {
        Write-Log "No restart needed - customizations were already applied" "INFO"
    }
}


Write-Log "================================================================================" "INFO"
Write-Log "Winhance Windows Optimization & Customization Script Completed" "SUCCESS"
Write-Log "================================================================================" "INFO"
]]></File>
  </Extensions>
</unattend>
